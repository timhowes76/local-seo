@model HomeDashboardViewModel
@{
    ViewData["Title"] = "Home";
    string StatusCss(string? label)
    {
        var key = (label ?? string.Empty).Trim().ToLowerInvariant();
        if (key.Contains("ok") || key.Contains("online") || key.Contains("operational"))
            return "status-healthy";
        if (key.Contains("pending") || key.Contains("processing"))
            return "status-pending";
        if (key.Contains("error") || key.Contains("down") || key.Contains("unavailable"))
            return "status-error";
        return "status-nodata";
    }
}

<div class="page-stack">
    <section class="card">
        <h2 class="card-title">Main Navigation</h2>
        <div class="home-nav-grid">
            <a href="/search" class="home-nav-card">
                <i class="bi bi-search home-nav-icon"></i>
                <span class="home-nav-title">Search</span>
                <span class="home-nav-subtitle">Run a new Google places search.</span>
            </a>
            <a href="/runs" class="home-nav-card">
                <i class="bi bi-list-check home-nav-icon"></i>
                <span class="home-nav-title">Runs</span>
                <span class="home-nav-subtitle">Review all captured runs and snapshots.</span>
            </a>
            <a href="/places" class="home-nav-card">
                <i class="bi bi-geo-alt home-nav-icon"></i>
                <span class="home-nav-title">Places</span>
                <span class="home-nav-subtitle">View places, details, and velocity metrics.</span>
            </a>
            <a href="/admin" class="home-nav-card">
                <i class="bi bi-gear home-nav-icon"></i>
                <span class="home-nav-title">Admin</span>
                <span class="home-nav-subtitle">Settings, maintenance, and DataForSEO tasks.</span>
            </a>
        </div>
    </section>

    <section class="card">
        <div class="card-header">
            <h2 class="card-title">DataForSEO Account</h2>
            <span class="muted">Updated @Model.RetrievedAtUtc.ToString("dd MMM yyyy HH:mm")</span>
        </div>

        <div class="stats-grid home-status-grid">
            <div class="stat-card">
                <span class="stat-label">Balance (USD)</span>
                <div class="stat-value">
                    @if (Model.DataForSeoBalanceDisplay is not null)
                    {
                        <span>$@Model.DataForSeoBalanceDisplay</span>
                    }
                    else
                    {
                        <span>N/A</span>
                    }
                </div>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(Model.AccountError))
        {
            <p class="notice">@Model.AccountError</p>
        }

        <p>
            <strong>API Status:</strong>
            @if (Model.ApiStatuses.Count == 0)
            {
                <span class="muted">No API status data available.</span>
            }
            else
            {
                <a href="#dataforseo-api-status-modal" id="open-dataforseo-api-status-modal-link">
                    View all endpoint statuses (@Model.ApiStatuses.Count)
                </a>
            }
        </p>
    </section>
</div>

@if (Model.ApiStatuses.Count > 0)
{
    <div id="dataforseo-api-status-modal" class="financial-modal-overlay is-hidden" aria-hidden="true">
        <div class="financial-modal-card" role="dialog" aria-modal="true" aria-labelledby="dataforseo-api-status-modal-title">
            <div class="financial-modal-header">
                <h3 id="dataforseo-api-status-modal-title">DataForSEO Endpoint Status</h3>
                <button type="button" class="btn btn-secondary" id="close-dataforseo-api-status-modal-button">Close</button>
            </div>
            <p class="muted">Current status for all configured DataForSEO endpoints.</p>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Service</th>
                            <th>Status</th>
                            <th>Description</th>
                            <th>Code</th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach (var row in Model.ApiStatuses)
                    {
                        <tr>
                            <td>@row.ServiceName</td>
                            <td><span class="status-pill @StatusCss(row.StatusLabel)">@row.StatusLabel</span></td>
                            <td>@row.StatusDescription</td>
                            <td>@(row.StatusCode?.ToString() ?? "N/A")</td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        (() => {
            const openLink = document.getElementById("open-dataforseo-api-status-modal-link");
            const closeButton = document.getElementById("close-dataforseo-api-status-modal-button");
            const modal = document.getElementById("dataforseo-api-status-modal");
            if (!openLink || !closeButton || !modal) return;

            const openModal = () => {
                modal.classList.remove("is-hidden");
                modal.setAttribute("aria-hidden", "false");
                document.body.classList.add("modal-open");
            };

            const closeModal = () => {
                modal.classList.add("is-hidden");
                modal.setAttribute("aria-hidden", "true");
                document.body.classList.remove("modal-open");
                openLink.focus();
            };

            openLink.addEventListener("click", (event) => {
                event.preventDefault();
                openModal();
            });

            closeButton.addEventListener("click", closeModal);

            modal.addEventListener("click", (event) => {
                if (event.target === modal) closeModal();
            });

            document.addEventListener("keydown", (event) => {
                if (event.key === "Escape" && !modal.classList.contains("is-hidden")) {
                    closeModal();
                }
            });
        })();
    </script>
}

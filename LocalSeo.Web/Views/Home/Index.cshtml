@model HomeDashboardViewModel
@{
    ViewData["Title"] = "Home";

    string StatusCss(string? label)
    {
        var key = (label ?? string.Empty).Trim().ToLowerInvariant();
        if (key.Contains("ok") || key.Contains("online") || key.Contains("operational"))
            return "status-healthy";
        if (key.Contains("pending") || key.Contains("processing"))
            return "status-pending";
        if (key.Contains("error") || key.Contains("down") || key.Contains("unavailable"))
            return "status-error";
        return "status-nodata";
    }

    string ApiStatusCss(LocalSeo.Web.Services.ApiHealthStatus status)
    {
        return status switch
        {
            LocalSeo.Web.Services.ApiHealthStatus.Up => "status-healthy",
            LocalSeo.Web.Services.ApiHealthStatus.Degraded => "status-pending",
            LocalSeo.Web.Services.ApiHealthStatus.Down => "status-error",
            _ => "status-nodata"
        };
    }

    string ApiStatusLabel(LocalSeo.Web.Services.ApiHealthStatus status)
    {
        return status switch
        {
            LocalSeo.Web.Services.ApiHealthStatus.Up => "Up",
            LocalSeo.Web.Services.ApiHealthStatus.Degraded => "Degraded",
            LocalSeo.Web.Services.ApiHealthStatus.Down => "Down",
            _ => "Unknown"
        };
    }

    string Relative(DateTime? checkedUtc)
    {
        if (!checkedUtc.HasValue)
            return "Never";

        var span = DateTime.UtcNow - checkedUtc.Value;
        if (span.TotalSeconds < 60)
            return $"{Math.Max(1, (int)Math.Floor(span.TotalSeconds))}s ago";
        if (span.TotalMinutes < 60)
            return $"{Math.Max(1, (int)Math.Floor(span.TotalMinutes))}m ago";
        if (span.TotalHours < 24)
            return $"{Math.Max(1, (int)Math.Floor(span.TotalHours))}h ago";
        return $"{Math.Max(1, (int)Math.Floor(span.TotalDays))}d ago";
    }
}

<div class="page-stack">
    <section class="card">
        <h2 class="card-title">Main Navigation</h2>
        <div class="home-nav-grid">
            <a href="/search" class="home-nav-card">
                <i class="bi bi-search home-nav-icon"></i>
                <span class="home-nav-title">Search</span>
                <span class="home-nav-subtitle">Run a new Google places search.</span>
            </a>
            <a href="/runs" class="home-nav-card">
                <i class="bi bi-list-check home-nav-icon"></i>
                <span class="home-nav-title">Runs</span>
                <span class="home-nav-subtitle">Review all captured runs and snapshots.</span>
            </a>
            <a href="/places" class="home-nav-card">
                <i class="bi bi-geo-alt home-nav-icon"></i>
                <span class="home-nav-title">Places</span>
                <span class="home-nav-subtitle">View places, details, and velocity metrics.</span>
            </a>
            <a href="/admin" class="home-nav-card">
                <i class="bi bi-gear home-nav-icon"></i>
                <span class="home-nav-title">Admin</span>
                <span class="home-nav-subtitle">Settings, maintenance, and DataForSEO tasks.</span>
            </a>
        </div>
    </section>

    <section class="card">
        <div class="card-header">
            <h2 class="card-title">DataForSEO Account</h2>
            <span class="muted">Updated @Model.RetrievedAtUtc.ToString("dd MMM yyyy HH:mm")</span>
        </div>

        <div class="stats-grid home-status-grid">
            <div class="stat-card">
                <span class="stat-label">Balance (USD)</span>
                <div class="stat-value">
                    @if (Model.DataForSeoBalanceDisplay is not null)
                    {
                        <span>$@Model.DataForSeoBalanceDisplay</span>
                    }
                    else
                    {
                        <span>N/A</span>
                    }
                </div>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(Model.AccountError))
        {
            <p class="notice">@Model.AccountError</p>
        }

        <p>
            <strong>API Status:</strong>
            @if (Model.ApiStatuses.Count == 0)
            {
                <span class="muted">No API status data available.</span>
            }
            else
            {
                <a href="#dataforseo-api-status-modal" id="open-dataforseo-api-status-modal-link">
                    View all endpoint statuses (@Model.ApiStatuses.Count)
                </a>
            }
        </p>
    </section>

    <section class="card">
        <div class="card-header">
            <h2 class="card-title">API Status</h2>
            <span class="muted">
                Updated
                @(Model.ApiStatusRetrievedAtUtc > DateTime.MinValue
                    ? Model.ApiStatusRetrievedAtUtc.ToString("dd MMM yyyy HH:mm")
                    : "N/A")
            </span>
        </div>

        <div class="toolbar api-status-toolbar">
            <a href="/api-status">View details</a>
            <button type="button" class="btn btn-secondary" id="api-status-refresh-button">Refresh now</button>
            <span id="api-status-refresh-message" class="muted" aria-live="polite"></span>
        </div>

        @if (Model.ApiStatusWidgets.Count == 0)
        {
            <p class="muted">No API status checks are configured yet.</p>
        }
        else
        {
            <div class="api-status-grid">
            @foreach (var row in Model.ApiStatusWidgets)
            {
                <article class="api-status-card">
                    <div class="api-status-card-head">
                        <h3>@row.DisplayName</h3>
                        <span class="status-pill @ApiStatusCss(row.Status)">@ApiStatusLabel(row.Status)</span>
                    </div>
                    <p class="muted">@row.Category</p>
                    <p class="api-status-card-meta">
                        Checked:
                        @if (row.CheckedUtc.HasValue)
                        {
                            <span title="@row.CheckedUtc.Value.ToString("yyyy-MM-dd HH:mm:ss 'UTC'")">@Relative(row.CheckedUtc)</span>
                        }
                        else
                        {
                            <span>Never</span>
                        }
                    </p>
                    <p class="api-status-card-meta">Latency: @(row.LatencyMs.HasValue ? $"{row.LatencyMs.Value} ms" : "N/A")</p>
                    <p class="api-status-card-message">@(string.IsNullOrWhiteSpace(row.Message) ? "No message." : row.Message)</p>
                </article>
            }
            </div>
        }

        <form id="api-status-refresh-form" method="post" action="/api-status/refresh" class="is-hidden">
            @Html.AntiForgeryToken()
        </form>
    </section>
</div>

@if (Model.ApiStatuses.Count > 0)
{
    <div id="dataforseo-api-status-modal" class="financial-modal-overlay is-hidden" aria-hidden="true">
        <div class="financial-modal-card" role="dialog" aria-modal="true" aria-labelledby="dataforseo-api-status-modal-title">
            <div class="financial-modal-header">
                <h3 id="dataforseo-api-status-modal-title">DataForSEO Endpoint Status</h3>
                <button type="button" class="btn btn-secondary" id="close-dataforseo-api-status-modal-button">Close</button>
            </div>
            <p class="muted">Current status for all configured DataForSEO endpoints.</p>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Service</th>
                            <th>Status</th>
                            <th>Description</th>
                            <th>Code</th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach (var row in Model.ApiStatuses)
                    {
                        <tr>
                            <td>@row.ServiceName</td>
                            <td><span class="status-pill @StatusCss(row.StatusLabel)">@row.StatusLabel</span></td>
                            <td>@row.StatusDescription</td>
                            <td>@(row.StatusCode?.ToString() ?? "N/A")</td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        (() => {
            const openLink = document.getElementById("open-dataforseo-api-status-modal-link");
            const closeButton = document.getElementById("close-dataforseo-api-status-modal-button");
            const modal = document.getElementById("dataforseo-api-status-modal");
            if (!openLink || !closeButton || !modal) return;

            const openModal = () => {
                modal.classList.remove("is-hidden");
                modal.setAttribute("aria-hidden", "false");
                document.body.classList.add("modal-open");
            };

            const closeModal = () => {
                modal.classList.add("is-hidden");
                modal.setAttribute("aria-hidden", "true");
                document.body.classList.remove("modal-open");
                openLink.focus();
            };

            openLink.addEventListener("click", (event) => {
                event.preventDefault();
                openModal();
            });

            closeButton.addEventListener("click", closeModal);

            modal.addEventListener("click", (event) => {
                if (event.target === modal) closeModal();
            });

            document.addEventListener("keydown", (event) => {
                if (event.key === "Escape" && !modal.classList.contains("is-hidden")) {
                    closeModal();
                }
            });
        })();
    </script>
}

<script>
    (() => {
        const refreshButton = document.getElementById("api-status-refresh-button");
        const refreshForm = document.getElementById("api-status-refresh-form");
        const message = document.getElementById("api-status-refresh-message");
        if (!refreshButton || !refreshForm || !message) return;

        const tokenInput = refreshForm.querySelector("input[name='__RequestVerificationToken']");
        if (!tokenInput) return;

        refreshButton.addEventListener("click", async () => {
            refreshButton.disabled = true;
            const originalText = refreshButton.textContent;
            refreshButton.textContent = "Refreshing...";
            message.textContent = "";

            try {
                const response = await fetch("/api-status/refresh", {
                    method: "POST",
                    headers: {
                        "RequestVerificationToken": tokenInput.value
                    }
                });

                const payload = await response.json();
                if (!response.ok || payload?.success !== true) {
                    message.textContent = payload?.message || "Refresh failed.";
                    return;
                }

                window.location.reload();
            } catch {
                message.textContent = "Refresh failed.";
            } finally {
                refreshButton.disabled = false;
                refreshButton.textContent = originalText || "Refresh now";
            }
        });
    })();
</script>

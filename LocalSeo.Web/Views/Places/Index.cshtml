@model PlacesIndexViewModel
@{
    ViewData["Title"] = "Places";
    var currentSort = (Model.Sort ?? string.Empty).Trim();
    var currentDirection = (Model.Direction ?? string.Empty).Trim();
    var placeNameQuery = (Model.PlaceNameQuery ?? string.Empty).Trim();
    var selectedKeyword = (Model.SelectedKeyword ?? string.Empty).Trim();
    var selectedLocation = (Model.SelectedLocation ?? string.Empty).Trim();

    string StatusCss(string? value, string fallback)
    {
        var key = (value ?? fallback).Trim().ToLowerInvariant().Replace(" ", string.Empty);
        return $"status-{key}";
    }
}

<div class="page-stack">
    <section class="card">
        <h2 class="card-title">Places</h2>
        <form method="get" action="/places" class="places-filter-line">
            <input type="hidden" name="sort" value="@currentSort" />
            <input type="hidden" name="direction" value="@currentDirection" />

            <label for="placeNameFilter">Place Name</label>
            <input id="placeNameFilter" name="placeName" type="text" value="@placeNameQuery" placeholder="Search place name" />

            <label for="keywordFilter">Keyword</label>
            <select id="keywordFilter" name="keyword" class="js-searchable" data-placeholder="Search">
                <option value="">All Keywords</option>
                @foreach (var keyword in Model.KeywordOptions)
                {
                    if (string.Equals(selectedKeyword, keyword, StringComparison.OrdinalIgnoreCase))
                    {
                        <option value="@keyword" selected>@keyword</option>
                    }
                    else
                    {
                        <option value="@keyword">@keyword</option>
                    }
                }
            </select>

            <label for="locationFilter">Location</label>
            <select id="locationFilter" name="location" class="js-searchable" data-placeholder="Search">
                <option value="">All Locations</option>
                @foreach (var location in Model.LocationOptions)
                {
                    if (string.Equals(selectedLocation, location, StringComparison.OrdinalIgnoreCase))
                    {
                        <option value="@location" selected>@location</option>
                    }
                    else
                    {
                        <option value="@location">@location</option>
                    }
                }
            </select>

            <button type="submit" class="btn btn-secondary">Apply</button>
            <a href="/places" class="btn btn-secondary">Clear</a>
        </form>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Primary Category</th>
                        <th>Avg Rating</th>
                        <th>Total Reviews</th>
                        <th>Reviews 90d</th>
                        <th>Days last review</th>
                        <th>Review Status</th>
                        <th>Number of Updates</th>
                        <th>Days last update</th>
                        <th>Update Status</th>
                        <th>Website</th>
                        <th>Description</th>
                        <th>Other Categories</th>
                        <th>Photos</th>
                        <th>Number of Q&amp;As</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var row in Model.Rows)
                {
                    var websiteYes = row.HasWebsite ?? false;
                    var hasOtherCategories = row.HasOtherCategories ?? false;
                    var descriptionLength = Math.Max(0, row.DescriptionLength ?? 0);
                    var descriptionPercent = Math.Clamp((int)Math.Round((descriptionLength / 750.0) * 100.0), 0, 100);
                    var descriptionStatusClass = descriptionPercent < 33
                        ? "status-error"
                        : descriptionPercent < 66
                            ? "status-pending"
                            : "status-healthy";

                    <tr>
                        <td>@(row.RankPosition?.ToString() ?? "N/A")</td>
                        <td>@(row.DisplayName ?? row.PlaceId)</td>
                        <td>@(string.IsNullOrWhiteSpace(row.PrimaryCategory) ? "N/A" : row.PrimaryCategory)</td>
                        <td>@(row.Rating?.ToString("0.0") ?? "N/A")</td>
                        <td>@(row.UserRatingCount?.ToString() ?? "N/A")</td>
                        <td>@(row.ReviewsLast90?.ToString() ?? "0")</td>
                        <td>@(row.DaysSinceLastReview?.ToString() ?? "N/A")</td>
                        <td><span class="status-pill @StatusCss(row.StatusLabel, "noreviews")">@(row.StatusLabel ?? "NoReviews")</span></td>
                        <td>@(row.UpdateCount?.ToString() ?? "0")</td>
                        <td>@(row.DaysSinceLastUpdate?.ToString() ?? "N/A")</td>
                        <td><span class="status-pill @StatusCss(row.UpdateStatusLabel, "noupdates")">@(row.UpdateStatusLabel ?? "NoUpdates")</span></td>
                        <td><span class="status-pill @(websiteYes ? "status-healthy" : "status-nodata")">@(websiteYes ? "Yes" : "No")</span></td>
                        <td><span class="status-pill @descriptionStatusClass">@descriptionPercent%</span></td>
                        <td><span class="status-pill @(hasOtherCategories ? "status-healthy" : "status-nodata")">@(hasOtherCategories ? "Yes" : "No")</span></td>
                        <td>@(row.PhotoCount?.ToString() ?? "N/A")</td>
                        <td>@(row.QuestionAnswerCount?.ToString() ?? "0")</td>
                        <td><a href="/places/@row.PlaceId">View</a></td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </section>
</div>


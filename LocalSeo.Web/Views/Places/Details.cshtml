@model PlaceDetailsViewModel
<h2>Location Details</h2>
@if (ViewBag.RequestedRunId != null)
{
    <p><a href="/runs/@ViewBag.RequestedRunId">Back to Run @ViewBag.RequestedRunId</a></p>
}

<div><strong>Name:</strong> @Model.DisplayName</div>
<div><strong>Place ID:</strong> @Model.PlaceId</div>
<div><strong>Address:</strong> @Model.FormattedAddress</div>
<div><strong>Primary Category:</strong> @(Model.PrimaryCategory ?? Model.PrimaryType ?? "N/A")</div>
<div><strong>Telephone:</strong> @(Model.NationalPhoneNumber ?? "N/A")</div>
<div>
    <strong>Website:</strong>
    @if (!string.IsNullOrWhiteSpace(Model.WebsiteUri))
    {
        <a href="@Model.WebsiteUri" target="_blank" rel="noopener noreferrer">@Model.WebsiteUri</a>
    }
    else
    {
        <span>N/A</span>
    }
</div>
<div><strong>Latitude:</strong> @Model.Lat</div>
<div><strong>Longitude:</strong> @Model.Lng</div>
<div><strong>Photo Count:</strong> @(Model.PhotoCount?.ToString() ?? "N/A")</div>
<div><strong>Description:</strong> @(Model.Description ?? "N/A")</div>
<div><strong>Service Area Business:</strong> @(Model.IsServiceAreaBusiness.HasValue ? (Model.IsServiceAreaBusiness.Value ? "Yes" : "No") : "N/A")</div>
<div><strong>Business Status:</strong> @(Model.BusinessStatus ?? "N/A")</div>
<div><strong>Active Run:</strong> @(Model.ActiveRunId?.ToString() ?? "N/A")</div>
<div><strong>Active Rank:</strong> @(Model.ActiveRankPosition?.ToString() ?? "N/A")</div>
<div><strong>Active Rating:</strong> @(Model.ActiveRating?.ToString() ?? "N/A")</div>
<div><strong>Active Rating Count:</strong> @(Model.ActiveUserRatingCount?.ToString() ?? "N/A")</div>
<div><strong>Captured At:</strong> @(Model.ActiveCapturedAtUtc?.ToString("u") ?? "N/A")</div>

<h3>Opening Hours</h3>
@if (Model.RegularOpeningHours.Count == 0)
{
    <p>N/A</p>
}
else
{
    <ul>
    @foreach (var row in Model.RegularOpeningHours)
    {
        <li>@row</li>
    }
    </ul>
}

<h3>Other Categories</h3>
@if (Model.OtherCategories.Count == 0)
{
    <p>None</p>
}
else
{
    <ul>
    @foreach (var category in Model.OtherCategories)
    {
        <li>@category</li>
    }
    </ul>
}

<h3>Social Profiles</h3>
<p>Not available from Google Places API. Requires Google Business Profile data.</p>

<h3>Service Areas</h3>
<p>Not available from Google Places API. Requires Google Business Profile data.</p>

<h3>Reviews</h3>
@if (Model.Reviews.Count == 0)
{
    <p>No stored reviews yet.</p>
}
else
{
    <table>
    <thead><tr><th>When</th><th>Profile</th><th>Rating</th><th>Review</th><th>Owner Reply</th><th>Link</th></tr></thead>
    <tbody>
    @foreach (var r in Model.Reviews)
    {
        <tr>
            <td>@(r.ReviewTimestampUtc?.ToString("u") ?? r.LastSeenUtc.ToString("u"))</td>
            <td>@(r.ProfileName ?? "N/A")</td>
            <td>@(r.Rating?.ToString() ?? "N/A")</td>
            <td>@(r.ReviewText ?? "N/A")</td>
            <td>@(r.OwnerAnswer ?? "N/A")</td>
            <td>
                @if (!string.IsNullOrWhiteSpace(r.ReviewUrl))
                {
                    <a href="@r.ReviewUrl" target="_blank" rel="noopener noreferrer">Open</a>
                }
                else
                {
                    <span>N/A</span>
                }
            </td>
        </tr>
    }
    </tbody>
    </table>
}

<h3>Recent History</h3>
<table>
<thead><tr><th>Run</th><th>Rank</th><th>Rating</th><th>Ratings</th><th>Captured</th></tr></thead>
<tbody>
@foreach (var h in Model.History)
{
    <tr>
        <td><a href="/runs/@h.SearchRunId">@h.SearchRunId</a></td>
        <td>@h.RankPosition</td>
        <td>@h.Rating</td>
        <td>@h.UserRatingCount</td>
        <td>@h.CapturedAtUtc</td>
    </tr>
}
</tbody>
</table>


@if (Model.ReviewVelocity is null || string.Equals(Model.ReviewVelocity.StatusLabel, "NoReviews", StringComparison.OrdinalIgnoreCase))
{
    <h3>Review Velocity</h3>
    <p>No reviews captured yet for this place.</p>
}
else
{
    var v = Model.ReviewVelocity;
    string summary = v.StatusLabel switch
    {
        "Slowing" => $"Review activity has slowed by {Math.Abs(v.Trend90Pct ?? 0):0.#}% vs the prior 90 days; consider running a review request campaign.",
        "Stalled" => $"No reviews in {v.DaysSinceLastReview ?? 0} days; visibility and conversion trust signals may decayâ€”prioritise generating new reviews.",
        "Accelerating" => $"Review activity is accelerating, up {v.Trend90Pct ?? 0:0.#}% in the last 90 days vs the prior period.",
        _ => $"Review activity is steady; last review was {v.DaysSinceLastReview ?? 0} days ago and the last 90 days are broadly stable vs the prior period."
    };

    <h3>Review Velocity</h3>
    <p>@summary</p>
    <table>
        <thead><tr><th>3m</th><th>6m</th><th>9m</th><th>12m</th><th>Avg/mo</th><th>Trend 90d</th><th>Days since</th><th>Longest gap 12m</th><th>Responded %</th><th>Avg response hrs</th><th>Momentum</th><th>Status</th></tr></thead>
        <tbody>
            <tr>
                <td>@(v.ReviewsLast90 ?? 0)</td>
                <td>@(v.ReviewsLast180 ?? 0)</td>
                <td>@(v.ReviewsLast270 ?? 0)</td>
                <td>@(v.ReviewsLast365 ?? 0)</td>
                <td>@(v.AvgPerMonth12m?.ToString("0.0") ?? "0.0")</td>
                <td>@(v.Trend90Pct?.ToString("+0.##;-0.##;0") ?? "0")%</td>
                <td>@(v.DaysSinceLastReview?.ToString() ?? "N/A")</td>
                <td>@(v.LongestGapDays12m?.ToString() ?? "N/A")</td>
                <td>@(v.RespondedPct12m?.ToString("0.##") ?? "N/A")%</td>
                <td>@(v.AvgOwnerResponseHours12m?.ToString("0.##") ?? "N/A")</td>
                <td>@(v.MomentumScore?.ToString() ?? "N/A")</td>
                <td><span class="status-pill status-@((v.StatusLabel ?? "healthy").ToLowerInvariant())">@v.StatusLabel</span></td>
            </tr>
        </tbody>
    </table>

    <h4>Monthly Reviews (last 24 months)</h4>
    <table>
        <thead><tr><th>Month</th><th>Reviews</th></tr></thead>
        <tbody>
        @foreach (var m in v.MonthlySeries)
        {
            <tr><td>@($"{m.Year}-{m.Month:00}")</td><td>@m.ReviewCount</td></tr>
        }
        </tbody>
    </table>

    <h4>Year Breakdown</h4>
    <table>
        <thead><tr><th>Year</th><th>Reviews</th><th>Avg Rating</th><th>Responded %</th></tr></thead>
        <tbody>
        @foreach (var y in v.YearBreakdown)
        {
            <tr><td>@y.Year</td><td>@y.ReviewCount</td><td>@(y.AvgRating?.ToString("0.00") ?? "N/A")</td><td>@(y.RespondedPct?.ToString("0.##") ?? "N/A")</td></tr>
        }
        </tbody>
    </table>

    @if (v.CompetitorBlock is not null)
    {
        <h4>Competitor Velocity</h4>
        <div>Competitor average reviews/mo (12m): @(v.CompetitorBlock.CompetitorAverageReviewsPerMonth12m?.ToString("0.00") ?? "N/A")</div>
        <table>
            <thead><tr><th>Name</th><th>Reviews 365d</th><th>Avg Rating</th><th>Days since last review</th></tr></thead>
            <tbody>
            @foreach (var c in v.CompetitorBlock.Competitors)
            {
                <tr><td>@c.Name</td><td>@c.ReviewsLast365</td><td>@(c.AvgRating?.ToString("0.00") ?? "N/A")</td><td>@(c.DaysSinceLastReview?.ToString() ?? "N/A")</td></tr>
            }
            </tbody>
        </table>
    }
}

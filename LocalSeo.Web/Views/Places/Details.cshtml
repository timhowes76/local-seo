@using System.Globalization
@using System.Text.Json
@using LocalSeo.Web.Models
@inject Microsoft.Extensions.Options.IOptions<LocalSeo.Web.Options.GoogleOptions> GoogleOptions
@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment WebHostEnvironment
@model PlaceDetailsViewModel
@{
    var displayNameForTitle = string.IsNullOrWhiteSpace(Model.DisplayName) ? "Location Details" : Model.DisplayName!;
    var hasRunContext = !string.IsNullOrWhiteSpace(Model.ContextSeedKeyword) && !string.IsNullOrWhiteSpace(Model.ContextLocationName);
    var pageHeading = hasRunContext
        ? $"{displayNameForTitle} ({Model.ContextSeedKeyword} in {Model.ContextLocationName})"
        : displayNameForTitle;
    ViewData["Title"] = pageHeading;
    var statusMessage = TempData["Status"] as string;
    var zohoTokenRefreshUrl = TempData["ZohoTokenRefreshUrl"] as string;
    var requestedRunId = ViewBag.RequestedRunId as long?;
    PlaceDataTaskStatusRow? GetTask(string taskType) =>
        Model.DataTaskStatuses.FirstOrDefault(x => string.Equals(x.TaskType, taskType, StringComparison.OrdinalIgnoreCase));
    bool IsNoDataStatus(string? status) =>
        string.Equals(status, "NoData", StringComparison.OrdinalIgnoreCase)
        || string.Equals(status, "CompletedNoData", StringComparison.OrdinalIgnoreCase)
        || string.Equals(status, "CompletedNoReviews", StringComparison.OrdinalIgnoreCase)
        || string.Equals(status, "CompletedNoUpdates", StringComparison.OrdinalIgnoreCase);
    bool IsNeverRun(string? status) =>
        string.Equals(status, "Never", StringComparison.OrdinalIgnoreCase);
    string DataStatusText(string? status) => (status ?? string.Empty) switch
    {
        "NoData" => "No Data",
        "CompletedNoData" => "No Data",
        "CompletedNoReviews" => "No Data",
        "CompletedNoUpdates" => "No Data",
        "Never" => "Never Run",
        _ => string.IsNullOrWhiteSpace(status) ? "N/A" : status
    };

    string DataStatusClass(string? status) => (status ?? string.Empty).ToLowerInvariant() switch
    {
        "ready" => "status-ready",
        "error" => "status-error",
        "nodata" => "status-nodata",
        "pending" => "status-pending",
        "created" => "status-pending",
        "populated" => "status-healthy",
        "completednoreviews" => "status-nodata",
        "completednodata" => "status-nodata",
        "completednoupdates" => "status-nodata",
        "never" => "status-noreviews",
        _ => "status-noreviews"
    };
    string NormalizeMultilineText(string? text)
    {
        if (string.IsNullOrWhiteSpace(text))
            return "N/A";

        return text
            .Replace("<br />", "\n", StringComparison.OrdinalIgnoreCase)
            .Replace("<br/>", "\n", StringComparison.OrdinalIgnoreCase)
            .Replace("<br>", "\n", StringComparison.OrdinalIgnoreCase)
            .Trim();
    }
    int FilledStarCount(decimal? rating)
    {
        if (!rating.HasValue)
            return 0;
        var rounded = (int)Math.Round(rating.Value, MidpointRounding.AwayFromZero);
        return Math.Clamp(rounded, 0, 5);
    }
    double GetWorkingHoursBetween(DateTime startUtc, DateTime endUtc)
    {
        if (endUtc <= startUtc)
            return 0;

        var cursor = startUtc;
        var hours = 0.0;
        while (cursor < endUtc)
        {
            var nextBoundary = cursor.Date.AddDays(1);
            var segmentEnd = endUtc < nextBoundary ? endUtc : nextBoundary;
            var isWorkingDay = cursor.DayOfWeek is not DayOfWeek.Saturday and not DayOfWeek.Sunday;
            if (isWorkingDay)
                hours += (segmentEnd - cursor).TotalHours;
            cursor = segmentEnd;
        }

        return hours;
    }
    string ResponseLagCss(double workingHours)
    {
        if (workingHours <= 24)
            return "status-healthy";
        if (workingHours <= 72)
            return "status-pending";
        return "status-error";
    }
    int CompleteMonthsBetween(DateTime startDate, DateTime endDate)
    {
        var start = startDate.Date;
        var end = endDate.Date;
        if (end < start)
            return 0;

        var months = (end.Year - start.Year) * 12 + end.Month - start.Month;
        if (end.Day < start.Day)
            months--;
        return Math.Max(0, months);
    }
    string FormatYearsAndMonths(int totalMonths)
    {
        var years = totalMonths / 12;
        var months = totalMonths % 12;
        if (years > 0 && months > 0)
            return $"{years}Y {months}M";
        if (years > 0)
            return $"{years}Y";
        return $"{months}M";
    }
    string FormatDateWithYearsAndMonths(DateTime? dateValue, DateTime referenceDate)
    {
        if (!dateValue.HasValue)
            return "N/A";

        var months = CompleteMonthsBetween(dateValue.Value, referenceDate);
        return $"{dateValue.Value:dd MMM yyyy} ({FormatYearsAndMonths(months)})";
    }
    string FormatDateWithYearsOnly(DateTime? dateValue, DateTime referenceDate)
    {
        if (!dateValue.HasValue)
            return "N/A";

        var years = referenceDate.Year - dateValue.Value.Year;
        if (referenceDate.Month < dateValue.Value.Month ||
            (referenceDate.Month == dateValue.Value.Month && referenceDate.Day < dateValue.Value.Day))
        {
            years--;
        }

        return $"{dateValue.Value:d MMM yyyy} ({Math.Max(0, years)}Y)";
    }
    string FormatDateOfBirthWithAge(DateTime? dateOfBirth, DateTime referenceDate)
    {
        if (!dateOfBirth.HasValue)
            return "N/A";

        var age = referenceDate.Year - dateOfBirth.Value.Year;
        if (referenceDate.Month < dateOfBirth.Value.Month)
            age--;
        age = Math.Max(age, 0);
        return $"{dateOfBirth.Value:MMM yyyy} ({age}Y)";
    }
    string FormatAppointedWithTenure(DateTime? appointedDate, DateTime? resignedDate, DateTime referenceDate)
    {
        if (!appointedDate.HasValue)
            return "N/A";

        var endDate = resignedDate.HasValue && resignedDate.Value.Date < referenceDate.Date
            ? resignedDate.Value.Date
            : referenceDate.Date;
        var months = CompleteMonthsBetween(appointedDate.Value, endDate);
        return $"{appointedDate.Value:dd MMM yyyy} ({FormatYearsAndMonths(months)})";
    }
    int CalendarMonthDelta(DateTime fromDate, DateTime toDate) =>
        (toDate.Year - fromDate.Year) * 12 + toDate.Month - fromDate.Month;
    string FormatNextAccountsDue(DateTime? dueDate, DateTime referenceDate)
    {
        if (!dueDate.HasValue)
            return "N/A";

        var due = dueDate.Value.Date;
        if (due < referenceDate.Date)
        {
            var monthsOverdue = CalendarMonthDelta(due, referenceDate);
            if (monthsOverdue <= 0)
                return $"{due:dd MMM yyyy} (overdue)";
            var overdueLabel = monthsOverdue == 1 ? "month" : "months";
            return $"{due:dd MMM yyyy} ({monthsOverdue} {overdueLabel} overdue)";
        }

        var monthsToGo = Math.Max(0, CalendarMonthDelta(referenceDate, due));
        var monthsLabel = monthsToGo == 1 ? "month" : "months";
        return $"{due:dd MMM yyyy} ({monthsToGo} {monthsLabel} to go)";
    }
    bool IsPastDue(DateTime? dueDate, DateTime referenceDate) =>
        dueDate.HasValue && dueDate.Value.Date < referenceDate.Date;
    bool IsCompanyActive(string? companyStatus) =>
        !string.IsNullOrWhiteSpace(companyStatus)
        && string.Equals(companyStatus.Trim(), "active", StringComparison.OrdinalIgnoreCase);
    string FormatCompanyStatus(string? companyStatus)
    {
        if (string.IsNullOrWhiteSpace(companyStatus))
            return "N/A";

        var normalized = companyStatus
            .Trim()
            .Replace('_', ' ')
            .Replace('-', ' ');
        if (string.Equals(normalized, "active", StringComparison.OrdinalIgnoreCase))
            return "Active";
        return CultureInfo.InvariantCulture.TextInfo.ToTitleCase(normalized.ToLowerInvariant());
    }
    string FormatPscDateOfBirth(int? month, int? year, DateTime referenceDate)
    {
        if (!month.HasValue || !year.HasValue || month.Value is < 1 or > 12)
            return string.Empty;

        var monthName = CultureInfo.InvariantCulture.DateTimeFormat.GetAbbreviatedMonthName(month.Value);
        var age = referenceDate.Year - year.Value;
        if (referenceDate.Month < month.Value)
            age--;
        age = Math.Max(age, 0);
        return $"{monthName} {year.Value} ({age}Y)";
    }
    string FormatAccountPeriodDate(DateTime? madeUpDate, DateTime? filingDate)
    {
        if (madeUpDate.HasValue)
            return madeUpDate.Value.ToString("dd MMM yyyy");
        if (filingDate.HasValue)
            return filingDate.Value.ToString("dd MMM yyyy");
        return "N/A";
    }
    var enhancedTask = GetTask("my_business_info");
    var reviewsTask = GetTask("reviews");
    var updatesTask = GetTask("my_business_updates");
    var reviewsNoData = IsNoDataStatus(reviewsTask?.Status);
    var reviewsNeverRun = IsNeverRun(reviewsTask?.Status);
    var updatesNoData = IsNoDataStatus(updatesTask?.Status);
    var updatesNeverRun = IsNeverRun(updatesTask?.Status);
    var enhancedNeverRun = IsNeverRun(enhancedTask?.Status);
    var reviewPage = Model.ReviewPage <= 0 ? 1 : Model.ReviewPage;
    var totalReviewPages = Math.Max(1, Model.TotalReviewPages);
    var hasPrevReviewPage = reviewPage > 1;
    var hasNextReviewPage = reviewPage < totalReviewPages;
    var createZohoLeadUrl = requestedRunId.HasValue
        ? $"/places/{Model.PlaceId}/zoho/create-lead?runId={requestedRunId.Value}"
        : $"/places/{Model.PlaceId}/zoho/create-lead";
    var editSocialLinksUrl = requestedRunId.HasValue
        ? $"/places/{Model.PlaceId}/edit?runId={requestedRunId.Value}"
        : $"/places/{Model.PlaceId}/edit";
    var zohoLeadUrl = string.IsNullOrWhiteSpace(Model.ZohoLeadId)
        ? null
        : $"https://crm.zoho.com/crm/org35245834/tab/Leads/{Uri.EscapeDataString(Model.ZohoLeadId)}";
    var zohoCreatedDateLabel = Model.ZohoLeadCreatedAtUtc?.ToString("dd MMM yyyy", CultureInfo.InvariantCulture);
    var overviewStarRating = Model.ActiveRating.HasValue
        ? Math.Floor(Model.ActiveRating.Value * 2m) / 2m
        : (decimal?)null;
    var overviewUpdatesCount = Model.Updates.Count;
    var socialProfiles = new (string Label, string? Url, string IconClass)[]
    {
        ("Facebook", Model.FacebookUrl, "bi-facebook"),
        ("Instagram", Model.InstagramUrl, "bi-instagram"),
        ("LinkedIn", Model.LinkedInUrl, "bi-linkedin"),
        ("X", Model.XUrl, "bi-twitter-x"),
        ("YouTube", Model.YouTubeUrl, "bi-youtube"),
        ("TikTok", Model.TikTokUrl, "bi-tiktok"),
        ("Pinterest", Model.PinterestUrl, "bi-pinterest"),
        ("Bluesky", Model.BlueskyUrl, "bi-cloud")
    };
    var activeSocialProfiles = socialProfiles
        .Where(x => !string.IsNullOrWhiteSpace(x.Url))
        .Select(x => (Label: x.Label, Url: x.Url!, IconClass: x.IconClass))
        .ToList();
    var logoUrl = string.IsNullOrWhiteSpace(Model.LogoUrl) ? null : Model.LogoUrl;
    string? localLogoUrl = null;
    if (!string.IsNullOrWhiteSpace(logoUrl)
        && logoUrl.StartsWith("/", StringComparison.Ordinal)
        && !logoUrl.StartsWith("//", StringComparison.Ordinal))
    {
        var webRootPath = WebHostEnvironment.WebRootPath ?? string.Empty;
        if (!string.IsNullOrWhiteSpace(webRootPath))
        {
            var rootFullPath = System.IO.Path.GetFullPath(webRootPath).TrimEnd(System.IO.Path.DirectorySeparatorChar, System.IO.Path.AltDirectorySeparatorChar);
            var relativePath = logoUrl.TrimStart('/').Replace('/', System.IO.Path.DirectorySeparatorChar);
            var candidateFullPath = System.IO.Path.GetFullPath(System.IO.Path.Combine(webRootPath, relativePath));
            var isUnderWebRoot = candidateFullPath.StartsWith(rootFullPath + System.IO.Path.DirectorySeparatorChar, StringComparison.OrdinalIgnoreCase)
                || string.Equals(candidateFullPath, rootFullPath, StringComparison.OrdinalIgnoreCase);
            if (isUnderWebRoot && System.IO.File.Exists(candidateFullPath))
                localLogoUrl = logoUrl;
        }
    }
    var mainPhotoUrl = string.IsNullOrWhiteSpace(Model.MainPhotoUrl) ? null : Model.MainPhotoUrl;
    var financialInfo = Model.FinancialInfo;
    var hasFinancialInfo = financialInfo is not null;
    var todayDate = DateTime.UtcNow.Date;
    var nextAccountsDueIsOverdue = IsPastDue(financialInfo?.NextAccountsDue, todayDate);
    var companyIsActive = IsCompanyActive(financialInfo?.CompanyStatus);
    var companyStatusDisplay = FormatCompanyStatus(financialInfo?.CompanyStatus);
    var hasFinancialPscs = Model.FinancialPersonsOfSignificantControl.Count > 0;
    var hasFinancialAccounts = Model.FinancialAccounts.Count > 0;
    var firstContactAvailability = Model.FirstContactReportAvailability;
    var reportRunId = requestedRunId ?? Model.ActiveRunId;
    var reportRunIdValue = reportRunId.GetValueOrDefault();
    var hasReportRunId = reportRunIdValue > 0;
    var canViewFirstContactReport = hasReportRunId && (firstContactAvailability?.IsAvailable ?? false);
    var reportBlockedMessage = hasReportRunId
        ? (string.IsNullOrWhiteSpace(firstContactAvailability?.Message)
            ? "Run again with Reviews enabled to generate this report."
            : firstContactAvailability!.Message)
        : "Open this place from a run to generate reports.";
    var firstContactClientUrl = hasReportRunId
        ? $"/reports/{Uri.EscapeDataString(Model.PlaceId)}/{reportRunIdValue}/first-contact?variant=client"
        : string.Empty;
    var firstContactInternalUrl = hasReportRunId
        ? $"/reports/{Uri.EscapeDataString(Model.PlaceId)}/{reportRunIdValue}/first-contact?variant=internal"
        : string.Empty;
    var firstContactClientPdf = firstContactAvailability?.Variants.FirstOrDefault(x => x.Variant == FirstContactReportVariant.ClientFacing)?.ExistingPdfPath;
    var firstContactInternalPdf = firstContactAvailability?.Variants.FirstOrDefault(x => x.Variant == FirstContactReportVariant.Internal)?.ExistingPdfPath;
    var financialSearchDefault = (Model.DisplayName ?? string.Empty).Trim();
    var financialLocationDefault = (Model.FormattedAddress ?? Model.SearchLocationName ?? string.Empty).Trim();
}

<div class="page-stack">
    @if (!string.IsNullOrWhiteSpace(statusMessage))
    {
        <div class="notice">
            @statusMessage
            @if (!string.IsNullOrWhiteSpace(zohoTokenRefreshUrl))
            {
                <a href="@zohoTokenRefreshUrl"> Refresh Zoho token</a>
            }
        </div>
    }
    @if (ViewBag.RequestedRunId != null)
    {
        <p><a href="/runs/@ViewBag.RequestedRunId">Back to Run @ViewBag.RequestedRunId</a></p>
    }
    <div class="details-top-grid">
        <section class="card">
            <h2 class="card-title">Overview</h2>
            <div class="overview-split">
                <div class="overview-main">
                    <div class="overview-name-row">
                        @if (!string.IsNullOrWhiteSpace(localLogoUrl))
                        {
                            <img class="overview-logo" src="@localLogoUrl" alt="@(Model.DisplayName ?? "Business") logo" loading="lazy" />
                        }
                        <div class="overview-name-block">
                            <div class="overview-name">@(Model.DisplayName ?? "N/A")</div>
                        </div>
                    </div>
                    <div class="overview-rating-line">
                        <span class="overview-rating-value">@(Model.ActiveRating?.ToString("0.0") ?? "N/A")</span>
                        <span class="rating-stars overview-rating-stars" aria-label="Rating @(Model.ActiveRating?.ToString("0.0") ?? "0.0") out of 5">
                            @if (overviewStarRating.HasValue)
                            {
                                for (var i = 1; i <= 5; i++)
                                {
                                    if (overviewStarRating.Value >= i)
                                    {
                                        <i class="bi bi-star-fill" aria-hidden="true"></i>
                                    }
                                    else if (overviewStarRating.Value >= i - 0.5m)
                                    {
                                        <i class="bi bi-star-half" aria-hidden="true"></i>
                                    }
                                    else
                                    {
                                        <i class="bi bi-star" aria-hidden="true"></i>
                                    }
                                }
                            }
                        </span>
                        <span class="overview-review-count">(@(Model.ActiveUserRatingCount?.ToString("N0") ?? "0"))</span>
                    </div>
                    <div class="overview-inline-stats">
                        <span><i class="bi bi-question-circle-fill" aria-hidden="true"></i> @(Model.QuestionAnswerCount?.ToString("N0") ?? "0")</span>
                        <span><i class="bi bi-images" aria-hidden="true"></i> @(Model.PhotoCount?.ToString("N0") ?? "0")</span>
                        <span><i class="bi bi-megaphone-fill" aria-hidden="true"></i> @overviewUpdatesCount.ToString("N0")</span>
                    </div>
                    <div class="overview-field">
                        <i class="bi bi-geo-alt-fill" aria-hidden="true"></i>
                        <span>@(Model.FormattedAddress ?? "N/A")</span>
                    </div>
                    <div class="overview-field">
                        <i class="bi bi-telephone-fill" aria-hidden="true"></i>
                        <span>@(Model.NationalPhoneNumber ?? "N/A")</span>
                    </div>
                    <div class="overview-field">
                        <i class="bi bi-globe2" aria-hidden="true"></i>
                        @if (!string.IsNullOrWhiteSpace(Model.WebsiteUri))
                        {
                            <a href="@Model.WebsiteUri" target="_blank" rel="noopener noreferrer">@Model.WebsiteUri</a>
                        }
                        else
                        {
                            <span>N/A</span>
                        }
                    </div>
                    <div class="overview-field">
                        <i class="bi bi-tag-fill" aria-hidden="true"></i>
                        <div class="overview-primary-block">
                            <div class="overview-primary-label">Primary Category</div>
                            <div class="overview-primary-value">@(Model.PrimaryCategory ?? Model.PrimaryType ?? "N/A")</div>
                        </div>
                    </div>
                    <div class="overview-field overview-financial-field">
                        <i class="bi bi-bank2" aria-hidden="true"></i>
                        <div class="overview-primary-block">
                            <div class="overview-primary-label">Financial Information</div>
                            @if (hasFinancialInfo)
                            {
                                <div class="overview-company-house">
                                    <div class="overview-company-house-row">
                                        <span class="overview-company-house-label">Company Number</span>
                                        <code>@financialInfo!.CompanyNumber</code>
                                    </div>
                                    <div class="overview-company-house-row">
                                        <span class="overview-company-house-label">Date Incorporated</span>
                                        <span>@FormatDateWithYearsOnly(financialInfo.DateOfCreation, todayDate)</span>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <button type="button"
                                        id="open-financial-modal-button"
                                        class="btn btn-secondary overview-financial-trigger">
                                    Get Financial Information
                                </button>
                            }
                        </div>
                    </div>
                    <div class="overview-field">
                        <i class="bi bi-person-vcard-fill" aria-hidden="true"></i>
                        <div class="overview-primary-block">
                            <div class="overview-primary-label">Zoho Lead</div>
                            <div class="zoho-lead-row">
                                @if (Model.ZohoLeadCreated)
                                {
                                    @if (!string.IsNullOrWhiteSpace(Model.ZohoLeadId) && !string.IsNullOrWhiteSpace(zohoLeadUrl))
                                    {
                                        <div class="zoho-lead-linkline">
                                            <a href="@zohoLeadUrl" target="_blank" rel="noopener noreferrer"><code>@Model.ZohoLeadId</code></a>
                                            @if (!string.IsNullOrWhiteSpace(zohoCreatedDateLabel))
                                            {
                                                <span class="muted">(@zohoCreatedDateLabel)</span>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="muted">
                                            Lead created
                                            @if (!string.IsNullOrWhiteSpace(zohoCreatedDateLabel))
                                            {
                                                <text> (@zohoCreatedDateLabel)</text>
                                            }
                                        </span>
                                    }
                                }
                                else
                                {
                                    <span class="status-pill status-nodata">Not Created</span>
                                    <form method="post" action="@createZohoLeadUrl" class="zoho-create-form">
                                        @Html.AntiForgeryToken()
                                        <button type="submit">Create Lead In Zoho</button>
                                    </form>
                                }

                                @if (!string.IsNullOrWhiteSpace(Model.ZohoLastError))
                                {
                                    <div class="zoho-sync-error">
                                        <strong>Last Zoho error:</strong> @Model.ZohoLastError
                                        @if (Model.ZohoLastSyncAtUtc.HasValue)
                                        {
                                            <span>(@Model.ZohoLastSyncAtUtc.Value.ToString("dd MMM yyyy HH:mm") UTC)</span>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <div class="overview-social">
                    <div class="overview-social-head">
                        <h3>Social Media</h3>
                        <a class="btn btn-secondary" href="@editSocialLinksUrl">Edit</a>
                    </div>
                    @if (activeSocialProfiles.Count == 0)
                    {
                        <p class="muted">No social media profiles found yet.</p>
                    }
                    else
                    {
                        <div class="social-links">
                            @foreach (var social in activeSocialProfiles)
                            {
                                <a class="social-link-item" href="@social.Url" target="_blank" rel="noopener noreferrer">
                                    <i class="bi @social.IconClass" aria-hidden="true"></i>
                                    <span>@social.Label</span>
                                </a>
                            }
                        </div>
                    }
                </div>
            </div>
        </section>

        <section class="card">
            <h2 class="card-title">Data</h2>
            @if (Model.DataTaskStatuses.Count == 0)
            {
                <p class="muted">No DataForSEO task history for this place yet.</p>
            }
            else
            {
                <table>
                    <thead>
                        <tr>
                            <th>Data Point</th>
                            <th>Last Run</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in Model.DataTaskStatuses)
                        {
                            <tr>
                                <td>@row.Label</td>
                                <td>
                                    @row.LastRunAgeLabel
                                    <div class="muted">Refresh window: @row.RefreshThresholdHours h</div>
                                </td>
                                <td>
                                    <span class="status-pill @DataStatusClass(row.Status)">@DataStatusText(row.Status)</span>
                                </td>
                                <td>
                                    <div class="toolbar">
                                        @if (row.IsReady && row.DataForSeoTaskRowId.HasValue)
                                        {
                                            <form method="post" action="/places/@Model.PlaceId/data/populate?runId=@requestedRunId">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="taskRowId" value="@row.DataForSeoTaskRowId.Value" />
                                                <button type="submit" class="btn btn-secondary">Grab Data</button>
                                            </form>
                                        }
                                        @if (row.CanRefresh)
                                        {
                                            <form method="post" action="/places/@Model.PlaceId/data/refresh?runId=@requestedRunId">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="taskType" value="@row.TaskType" />
                                                <button type="submit">Refresh</button>
                                            </form>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </section>
    </div>

    @if (Model.EstimatedTraffic is not null)
    {
        var traffic = Model.EstimatedTraffic;
        <section class="card estimated-traffic-card">
            <h2 class="card-title">Estimated Traffic</h2>
            <div class="estimated-traffic-grid">
                <div class="estimated-traffic-metric">
                    <span class="estimated-traffic-label">Current Map Position</span>
                    <span class="estimated-traffic-value">@(traffic.CurrentMapPosition.ToString("N0"))</span>
                </div>
                <div class="estimated-traffic-metric">
                    <span class="estimated-traffic-label">Estimated Monthly Map Visits</span>
                    <span class="estimated-traffic-value">@traffic.EstimatedMonthlyMapVisits.ToString("N0")</span>
                </div>
                <div class="estimated-traffic-metric">
                    <span class="estimated-traffic-label">Estimated Visits at Position 3</span>
                    <span class="estimated-traffic-value">@traffic.EstimatedVisitsAtPosition3.ToString("N0")</span>
                </div>
                <div class="estimated-traffic-metric">
                    <span class="estimated-traffic-label">Estimated Visits at Position 1</span>
                    <span class="estimated-traffic-value">@traffic.EstimatedVisitsAtPosition1.ToString("N0")</span>
                </div>
            </div>

            @if (traffic.CurrentMapPosition > 1)
            {
                <div class="estimated-traffic-gap">
                    <h3>Traffic Opportunity Gap</h3>
                    @if (traffic.CurrentMapPosition > 3 && traffic.OpportunityToPosition3.HasValue)
                    {
                        <div><strong>To Position 3:</strong> +@traffic.OpportunityToPosition3.Value.ToString("N0") visits/month</div>
                    }
                    @if (traffic.OpportunityToPosition1.HasValue)
                    {
                        <div><strong>To Position 1:</strong> +@traffic.OpportunityToPosition1.Value.ToString("N0") visits/month</div>
                    }
                </div>
            }
        </section>
    }

@{
    var apiKey = GoogleOptions.Value.ApiKey;
    var hasBusinessCoords = Model.Lat.HasValue && Model.Lng.HasValue;
    var hasRunCenter = Model.RunCenterLat.HasValue && Model.RunCenterLng.HasValue;
    var velocity = Model.ReviewVelocity;
    var updateVelocity = Model.UpdateVelocity;
}

<section class="card">
<h2 class="card-title">Map</h2>
@if (string.IsNullOrWhiteSpace(apiKey))
{
    <p class="muted">Map unavailable because Google API key is not configured.</p>
}
else if (!hasBusinessCoords && !hasRunCenter)
{
    <p class="muted">Map unavailable because coordinates are missing.</p>
}
else
{
    <div id="place-details-map" class="map-medium"></div>
    <p class="muted">
        <strong>Legend:</strong> Red marker = business location.
        @if (hasRunCenter)
        {
            <span>Blue marker = run center (Run #@(Model.MapRunId?.ToString() ?? "N/A")).</span>
        }
    </p>
    <script>
        const businessLocation = {
            lat: @((Model.Lat?.ToString(System.Globalization.CultureInfo.InvariantCulture)) ?? "null"),
            lng: @((Model.Lng?.ToString(System.Globalization.CultureInfo.InvariantCulture)) ?? "null")
        };
        const runCenterLocation = {
            lat: @((Model.RunCenterLat?.ToString(System.Globalization.CultureInfo.InvariantCulture)) ?? "null"),
            lng: @((Model.RunCenterLng?.ToString(System.Globalization.CultureInfo.InvariantCulture)) ?? "null")
        };

        function initPlaceDetailsMap() {
            const hasBusiness = businessLocation.lat !== null && businessLocation.lng !== null;
            const hasCenter = runCenterLocation.lat !== null && runCenterLocation.lng !== null;
            if (!hasBusiness && !hasCenter) return;

            const defaultCenter = hasBusiness
                ? { lat: businessLocation.lat, lng: businessLocation.lng }
                : { lat: runCenterLocation.lat, lng: runCenterLocation.lng };
            const map = new google.maps.Map(document.getElementById("place-details-map"), {
                center: defaultCenter,
                zoom: 14
            });
            const bounds = new google.maps.LatLngBounds();

            if (hasBusiness) {
                const businessPoint = { lat: businessLocation.lat, lng: businessLocation.lng };
                new google.maps.Marker({
                    map,
                    position: businessPoint,
                    title: "Business Location",
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 11,
                        fillColor: "#e53935",
                        fillOpacity: 1,
                        strokeColor: "#7f0000",
                        strokeWeight: 2
                    }
                });
                bounds.extend(businessPoint);
            }

            if (hasCenter) {
                const centerPoint = { lat: runCenterLocation.lat, lng: runCenterLocation.lng };
                new google.maps.Marker({
                    map,
                    position: centerPoint,
                    title: "Run Center",
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 11,
                        fillColor: "#1a73e8",
                        fillOpacity: 1,
                        strokeColor: "#0b3d91",
                        strokeWeight: 2
                    }
                });
                bounds.extend(centerPoint);
            }

            if (!bounds.isEmpty()) {
                map.fitBounds(bounds);
                if (hasBusiness && hasCenter && map.getZoom() > 14) {
                    map.setZoom(14);
                }
            }
        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=@System.Uri.EscapeDataString(apiKey)&callback=initPlaceDetailsMap"></script>
}
</section>

<section class="card">
<h2 class="card-title">Review Velocity</h2>
@if (velocity is null || string.Equals(velocity.StatusLabel, "NoReviews", StringComparison.OrdinalIgnoreCase))
{
    @if (reviewsNoData)
    {
        <p class="muted">Google Review collection returned <strong>No Data</strong> for this place, so there are no reviews to import right now.</p>
    }
    else if (reviewsNeverRun)
    {
        <p class="muted">Google Review collection has never been run for this place yet.</p>
    }
    else
    {
        <p class="muted">No reviews captured yet for this place.</p>
    }
}
else
{
    var reviews3m = Math.Max(0, velocity.ReviewsLast90 ?? 0);
    var reviews6m = Math.Max(0, (velocity.ReviewsLast180 ?? 0) - (velocity.ReviewsLast90 ?? 0));
    var reviews9m = Math.Max(0, (velocity.ReviewsLast270 ?? 0) - (velocity.ReviewsLast180 ?? 0));
    var reviews12m = Math.Max(0, (velocity.ReviewsLast365 ?? 0) - (velocity.ReviewsLast270 ?? 0));
    string summary = velocity.StatusLabel switch
    {
        "Slowing" => $"Review activity has slowed by {Math.Abs(velocity.Trend90Pct ?? 0):0.#}% vs the prior 90 days.",
        "Stalled" => $"No reviews in {velocity.DaysSinceLastReview ?? 0} days.",
        "Accelerating" => $"Review activity is accelerating, up {velocity.Trend90Pct ?? 0:0.#}% in the last 90 days vs the prior period.",
        _ => $"Review activity is steady; last review was {velocity.DaysSinceLastReview ?? 0} days ago."
    };

    <p>@summary</p>
    <table>
        <thead><tr><th>3m</th><th>6m</th><th>9m</th><th>12m</th><th>Avg/mo</th><th>Days since</th><th>Longest gap 12m</th><th>Responded %</th><th>Avg response hrs</th><th>Status</th></tr></thead>
        <tbody>
            <tr>
                <td>@reviews3m</td>
                <td>@reviews6m</td>
                <td>@reviews9m</td>
                <td>@reviews12m</td>
                <td>@(velocity.AvgPerMonth12m?.ToString("0.0") ?? "0.0")</td>
                <td>@(velocity.DaysSinceLastReview?.ToString() ?? "N/A")</td>
                <td>@(velocity.LongestGapDays12m?.ToString() ?? "N/A")</td>
                <td>@(velocity.RespondedPct12m?.ToString("0.##") ?? "N/A")%</td>
                <td>@(velocity.AvgOwnerResponseHours12m?.ToString("0.##") ?? "N/A")</td>
                <td><span class="status-pill status-@((velocity.StatusLabel ?? "healthy").ToLowerInvariant())">@velocity.StatusLabel</span></td>
            </tr>
        </tbody>
    </table>
}
</section>

<section class="card">
<h2 class="card-title">Updates Velocity</h2>
@if (updateVelocity is null || string.Equals(updateVelocity.StatusLabel, "NoUpdates", StringComparison.OrdinalIgnoreCase))
{
    @if (updatesNoData)
    {
        <p class="muted">Google Updates collection returned <strong>No Data</strong> for this place, so there are no updates to import right now.</p>
    }
    else if (updatesNeverRun)
    {
        <p class="muted">Google Updates collection has never been run for this place yet.</p>
    }
    else
    {
        <p class="muted">No updates captured yet for this place.</p>
    }
}
else
{
    var updates3m = Math.Max(0, updateVelocity.UpdatesLast90 ?? 0);
    var updates6m = Math.Max(0, (updateVelocity.UpdatesLast180 ?? 0) - (updateVelocity.UpdatesLast90 ?? 0));
    var updates9m = Math.Max(0, (updateVelocity.UpdatesLast270 ?? 0) - (updateVelocity.UpdatesLast180 ?? 0));
    var updates12m = Math.Max(0, (updateVelocity.UpdatesLast365 ?? 0) - (updateVelocity.UpdatesLast270 ?? 0));

    <table>
        <thead><tr><th>Last update</th><th>3m</th><th>6m</th><th>9m</th><th>12m</th><th>Status</th></tr></thead>
        <tbody>
            <tr>
                <td>@(updateVelocity.DaysSinceLastUpdate?.ToString() ?? "N/A") day(s) ago</td>
                <td>@updates3m</td>
                <td>@updates6m</td>
                <td>@updates9m</td>
                <td>@updates12m</td>
                <td><span class="status-pill status-@((updateVelocity.StatusLabel ?? "healthy").ToLowerInvariant())">@updateVelocity.StatusLabel</span></td>
            </tr>
        </tbody>
    </table>
}
</section>

<div class="details-tab-buttons">
    <button type="button" data-tab-button="details" class="details-tab-button">Detail</button>
    <button type="button" data-tab-button="main-photo" class="details-tab-button">Main Photo</button>
    <button type="button" data-tab-button="reviews" class="details-tab-button">Reviews</button>
    <button type="button" data-tab-button="updates" class="details-tab-button">Updates</button>
    <button type="button" data-tab-button="questions-answers" class="details-tab-button">Questions &amp; Answers</button>
    <button type="button" data-tab-button="rank-history" class="details-tab-button">Rank History</button>
    <button type="button" data-tab-button="reports" class="details-tab-button">Reports</button>
    @if (hasFinancialInfo)
    {
        <button type="button" data-tab-button="financials" class="details-tab-button">Financials</button>
    }
    <button type="button" data-tab-button="tech" class="details-tab-button">Tech</button>
</div>

<div id="tab-details" class="details-tab-panel card">
    <h3>Detail</h3>
    @if (enhancedNeverRun)
    {
        <p class="muted">Google Enhanced Data collection has never been run for this place yet.</p>
    }
    @{
        var descriptionText = Model.Description?.Trim() ?? string.Empty;
        var descriptionCharCount = descriptionText.Length;
        var descriptionCharsRemaining = Math.Max(0, 750 - descriptionCharCount);
    }
    <h4>Description</h4>
    @if (string.IsNullOrWhiteSpace(descriptionText))
    {
        <p>N/A</p>
    }
    else
    {
        <p>@descriptionText</p>
    }
    <p class="muted">Could use @descriptionCharsRemaining more characters (Google limit: 750).</p>

    <h4>Business Status</h4>
    <p>@(Model.BusinessStatus ?? "N/A")</p>

    <h4>Opening Hours</h4>
    @if (Model.RegularOpeningHours.Count == 0)
    {
        <p>N/A</p>
    }
    else
    {
        <ul>
        @foreach (var row in Model.RegularOpeningHours)
        {
            <li>@row</li>
        }
        </ul>
    }

    <h4>Other Categories</h4>
    @if (Model.OtherCategories.Count == 0)
    {
        <p>None</p>
    }
    else
    {
        <ul>
        @foreach (var category in Model.OtherCategories)
        {
            <li>@category</li>
        }
        </ul>
    }

    <h4>Place Topics</h4>
    @if (Model.PlaceTopics.Count == 0)
    {
        <p>None</p>
    }
    else
    {
        <ul>
        @foreach (var topic in Model.PlaceTopics)
        {
            <li>@topic</li>
        }
        </ul>
    }
</div>

<div id="tab-main-photo" class="details-tab-panel card is-hidden">
    <h3>Main Photo</h3>
    @if (string.IsNullOrWhiteSpace(mainPhotoUrl))
    {
        <p class="muted">No main photo has been downloaded yet.</p>
    }
    else
    {
        <div class="place-main-photo-frame">
            <img class="place-main-photo-image"
                 src="@mainPhotoUrl"
                 alt="@(Model.DisplayName ?? "Place") main photo"
                 loading="lazy" />
        </div>
    }
</div>

<div id="tab-reviews" class="details-tab-panel card is-hidden">
    <h3>Reviews</h3>
    <h4>Reviews over time</h4>
    @if (velocity is null || velocity.MonthlySeries.Count == 0)
    {
        <p>No monthly review data available.</p>
    }
    else
    {
        var runningTotal = 0;
        var cumulativeSeries = velocity.MonthlySeries
            .OrderBy(m => m.Year)
            .ThenBy(m => m.Month)
            .Select(m => new
            {
                label = $"{m.Year}-{m.Month:00}",
                total = (runningTotal += m.ReviewCount)
            })
            .ToList();
        var monthlyJson = JsonSerializer.Serialize(
            cumulativeSeries.Select(m => new { label = m.label, value = m.total }));
        <div id="reviews-over-time-chart" class="chart-panel"></div>
        <script>
            (() => {
                const data = @Html.Raw(monthlyJson);
                const host = document.getElementById("reviews-over-time-chart");
                if (!host || !data || data.length === 0) return;

                const renderReviewsOverTimeChart = () => {
                    const tabReviews = document.getElementById("tab-reviews");
                    if (tabReviews?.classList.contains("is-hidden")) return;

                    const measuredWidth = host.clientWidth || host.parentElement?.clientWidth || 0;
                    if (measuredWidth < 320) return;

                    const width = Math.max(960, Math.floor(measuredWidth));
                    const height = 320;
                    const margin = { top: 20, right: 24, bottom: 56, left: 56 };
                    const plotW = width - margin.left - margin.right;
                    const plotH = height - margin.top - margin.bottom;
                    const maxY = Math.max(1, ...data.map(d => d.value));
                    const xStep = data.length > 1 ? plotW / (data.length - 1) : 0;
                    const yPos = (v) => margin.top + plotH - ((v / maxY) * plotH);
                    const xPos = (i) => margin.left + (xStep * i);
                    const points = data.map((d, i) => `${xPos(i)},${yPos(d.value)}`).join(" ");

                    const xTicks = data.map((d, i) => {
                        if (i % Math.max(1, Math.floor(data.length / 8)) !== 0 && i !== data.length - 1) return "";
                        return `<text x="${xPos(i)}" y="${height - 24}" text-anchor="middle" font-size="11" fill="#555">${d.label}</text>`;
                    }).join("");

                    const yTicks = Array.from({ length: 5 }, (_, i) => Math.round((maxY / 4) * (4 - i)));
                    const yTickLines = yTicks.map(v => {
                        const y = yPos(v);
                        return `<line x1="${margin.left}" y1="${y}" x2="${width - margin.right}" y2="${y}" stroke="#eee"/><text x="${margin.left - 8}" y="${y + 4}" text-anchor="end" font-size="11" fill="#555">${v}</text>`;
                    }).join("");

                    host.innerHTML = `
<svg width="100%" height="${height}" viewBox="0 0 ${width} ${height}" role="img" aria-label="Reviews over time total reviews chart">
  <rect x="0" y="0" width="${width}" height="${height}" fill="#fff"/>
  ${yTickLines}
  <line x1="${margin.left}" y1="${margin.top + plotH}" x2="${width - margin.right}" y2="${margin.top + plotH}" stroke="#333"/>
  <line x1="${margin.left}" y1="${margin.top}" x2="${margin.left}" y2="${margin.top + plotH}" stroke="#333"/>
  ${xTicks}
  <polyline points="${points}" fill="none" stroke="#b0b0b0" stroke-width="1"/>
  ${data.map((d, i) => `<circle cx="${xPos(i)}" cy="${yPos(d.value)}" r="4" fill="#1a73e8"><title>${d.label}: ${d.value}</title></circle>`).join("")}
  <text x="${width / 2}" y="${height - 6}" text-anchor="middle" font-size="12" fill="#333">Time</text>
  <text x="16" y="${margin.top + (plotH / 2)}" text-anchor="middle" font-size="12" fill="#333" transform="rotate(-90 16 ${margin.top + (plotH / 2)})">Total Reviews</text>
</svg>`;
                };

                window.renderReviewsOverTimeChart = renderReviewsOverTimeChart;
                window.addEventListener("resize", renderReviewsOverTimeChart);
                renderReviewsOverTimeChart();
            })();
        </script>
    }

    <h4>Year Breakdown</h4>
    @if (velocity is null || velocity.YearBreakdown.Count == 0)
    {
        <p>No yearly review data available.</p>
    }
    else
    {
        <table>
            <thead><tr><th>Year</th><th>Reviews</th><th>Avg Rating</th><th>Responded %</th></tr></thead>
            <tbody>
            @foreach (var y in velocity.YearBreakdown)
            {
                <tr>
                    <td>@y.Year</td>
                    <td>@y.ReviewCount</td>
                    <td>@(y.AvgRating?.ToString("0.00") ?? "N/A")</td>
                    <td>@(y.RespondedPct?.ToString("0.##") ?? "N/A")</td>
                </tr>
            }
            </tbody>
        </table>
    }

    <h4>Review Log</h4>
    @if (Model.Reviews.Count == 0)
    {
        @if (reviewsNoData)
        {
            <p>No stored reviews yet. Google Review collection reported <strong>No Data</strong> for this place.</p>
        }
        else if (reviewsNeverRun)
        {
            <p>No stored reviews yet. Google Review collection has never been run for this place.</p>
        }
        else
        {
            <p>No stored reviews yet.</p>
        }
    }
    else
    {
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Profile</th>
                        <th>Rating</th>
                        <th>Review &amp; Reply</th>
                        <th>Link</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var r in Model.Reviews)
                {
                    var reviewDate = (r.ReviewTimestampUtc ?? r.LastSeenUtc).ToString("dd MMM yyyy");
                    var replyDate = r.OwnerTimestampUtc?.ToString("dd MMM yyyy");
                    var filledStars = FilledStarCount(r.Rating);
                    var reviewReferenceUtc = r.ReviewTimestampUtc ?? r.LastSeenUtc;
                    double? responseWorkingHours = r.OwnerTimestampUtc.HasValue
                        ? GetWorkingHoursBetween(reviewReferenceUtc, r.OwnerTimestampUtc.Value)
                        : null;
                    var responseWorkingDays = responseWorkingHours.HasValue
                        ? Math.Max(0, (int)Math.Floor(responseWorkingHours.Value / 24d))
                        : 0;
                    var responseDaysLabel = responseWorkingDays == 1 ? "1 day" : $"{responseWorkingDays} days";
                    <tr>
                        <td>@reviewDate</td>
                        <td>@(r.ProfileName ?? "N/A")</td>
                        <td>
                            <span class="rating-stars" aria-label="Rating @(r.Rating?.ToString("0.0") ?? "0.0") out of 5">
                                @for (var i = 0; i < 5; i++)
                                {
                                    if (i < filledStars)
                                    {
                                        <i class="bi bi-star-fill"></i>
                                    }
                                    else
                                    {
                                        <i class="bi bi-star"></i>
                                    }
                                }
                            </span>
                        </td>
                        <td>
                            <div class="review-text">@NormalizeMultilineText(r.ReviewText)</div>
                            @if (!string.IsNullOrWhiteSpace(r.OwnerAnswer))
                            {
                                <div class="review-reply-block">
                                    <div class="review-reply-title">
                                        Reply
                                        @if (!string.IsNullOrWhiteSpace(replyDate))
                                        {
                                            <span>(@replyDate)</span>
                                            @if (responseWorkingHours.HasValue)
                                            {
                                                <span class="status-pill @ResponseLagCss(responseWorkingHours.Value)">
                                                    + @responseDaysLabel
                                                </span>
                                            }
                                        }
                                    </div>
                                    <div class="review-reply-text">@NormalizeMultilineText(r.OwnerAnswer)</div>
                                </div>
                            }
                        </td>
                        <td>
                            @if (!string.IsNullOrWhiteSpace(r.ReviewUrl))
                            {
                                <a href="@r.ReviewUrl" target="_blank" rel="noopener noreferrer">Open</a>
                            }
                            else
                            {
                                <span>N/A</span>
                            }
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </div>

        @if (totalReviewPages > 1)
        {
            var prevUrl = $"/places/{Model.PlaceId}?reviewPage={reviewPage - 1}&tab=reviews";
            var nextUrl = $"/places/{Model.PlaceId}?reviewPage={reviewPage + 1}&tab=reviews";
            if (requestedRunId.HasValue)
            {
                prevUrl += $"&runId={requestedRunId.Value}";
                nextUrl += $"&runId={requestedRunId.Value}";
            }

            <div class="toolbar review-pager">
                @if (hasPrevReviewPage)
                {
                    <a class="btn btn-secondary" href="@prevUrl">Previous</a>
                }
                else
                {
                    <button type="button" class="btn btn-secondary" disabled>Previous</button>
                }
                <span class="muted">Page @reviewPage of @totalReviewPages (@Model.TotalReviewCount total)</span>
                @if (hasNextReviewPage)
                {
                    <a class="btn btn-secondary" href="@nextUrl">Next</a>
                }
                else
                {
                    <button type="button" class="btn btn-secondary" disabled>Next</button>
                }
            </div>
        }
    }
</div>

<div id="tab-updates" class="details-tab-panel card is-hidden">
    <h3>Updates</h3>
    @if (Model.Updates.Count == 0)
    {
        @if (updatesNoData)
        {
            <p>No stored updates yet. Google Updates collection reported <strong>No Data</strong> for this place.</p>
        }
        else if (updatesNeverRun)
        {
            <p>No stored updates yet. Google Updates collection has never been run for this place.</p>
        }
        else
        {
            <p>No stored updates yet.</p>
        }
    }
    else
    {
        <table>
        <thead><tr><th>When</th><th>Post</th><th>URL</th><th>Images</th><th>Links</th></tr></thead>
        <tbody>
        @foreach (var u in Model.Updates)
        {
            <tr>
                <td>@(u.PostDateUtc?.ToString("dd MMM yyyy HH:mm") ?? u.LastSeenUtc.ToString("dd MMM yyyy HH:mm"))</td>
                <td>@(u.PostText ?? "N/A")</td>
                <td>
                    @if (!string.IsNullOrWhiteSpace(u.Url))
                    {
                        <a href="@u.Url" target="_blank" rel="noopener noreferrer">Open</a>
                    }
                    else
                    {
                        <span>N/A</span>
                    }
                </td>
                <td>@u.ImageUrls.Count</td>
                <td>
                    @if (u.Links.Count == 0)
                    {
                        <span>N/A</span>
                    }
                    else
                    {
                        foreach (var link in u.Links)
                        {
                            var label = string.IsNullOrWhiteSpace(link.Title)
                                ? (string.IsNullOrWhiteSpace(link.Type) ? "Link" : link.Type)
                                : link.Title;
                            if (!string.IsNullOrWhiteSpace(link.Url))
                            {
                                <a href="@link.Url" target="_blank" rel="noopener noreferrer">@label</a><br />
                            }
                            else
                            {
                                <span>@label</span><br />
                            }
                        }
                    }
                </td>
            </tr>
        }
        </tbody>
        </table>
    }

    <h4>Updates over time</h4>
    @if (updateVelocity is null || updateVelocity.MonthlySeries.Count == 0)
    {
        <p>No monthly update data available.</p>
    }
    else
    {
        var runningTotalUpdates = 0;
        var cumulativeUpdateSeries = updateVelocity.MonthlySeries
            .OrderBy(m => m.Year)
            .ThenBy(m => m.Month)
            .Select(m => new
            {
                label = $"{m.Year}-{m.Month:00}",
                total = (runningTotalUpdates += m.UpdateCount)
            })
            .ToList();
        var updatesMonthlyJson = JsonSerializer.Serialize(cumulativeUpdateSeries.Select(m => new { label = m.label, value = m.total }));
        <div id="updates-over-time-chart" class="chart-panel"></div>
        <script>
            (() => {
                const data = @Html.Raw(updatesMonthlyJson);
                const host = document.getElementById("updates-over-time-chart");
                if (!host || !data || data.length === 0) return;

                const renderUpdatesOverTimeChart = () => {
                    const tabUpdates = document.getElementById("tab-updates");
                    if (tabUpdates?.classList.contains("is-hidden")) return;

                    const measuredWidth = host.clientWidth || host.parentElement?.clientWidth || 0;
                    if (measuredWidth < 320) return;

                    const width = Math.max(960, Math.floor(measuredWidth));
                    const height = 320;
                    const margin = { top: 20, right: 24, bottom: 56, left: 56 };
                    const plotW = width - margin.left - margin.right;
                    const plotH = height - margin.top - margin.bottom;
                    const maxY = Math.max(1, ...data.map(d => d.value));
                    const xStep = data.length > 1 ? plotW / (data.length - 1) : 0;
                    const yPos = (v) => margin.top + plotH - ((v / maxY) * plotH);
                    const xPos = (i) => margin.left + (xStep * i);
                    const points = data.map((d, i) => `${xPos(i)},${yPos(d.value)}`).join(" ");

                    const xTicks = data.map((d, i) => {
                        if (i % Math.max(1, Math.floor(data.length / 8)) !== 0 && i !== data.length - 1) return "";
                        return `<text x="${xPos(i)}" y="${height - 24}" text-anchor="middle" font-size="11" fill="#555">${d.label}</text>`;
                    }).join("");

                    const yTicks = Array.from({ length: 5 }, (_, i) => Math.round((maxY / 4) * (4 - i)));
                    const yTickLines = yTicks.map(v => {
                        const y = yPos(v);
                        return `<line x1="${margin.left}" y1="${y}" x2="${width - margin.right}" y2="${y}" stroke="#eee"/><text x="${margin.left - 8}" y="${y + 4}" text-anchor="end" font-size="11" fill="#555">${v}</text>`;
                    }).join("");

                    host.innerHTML = `
<svg width="100%" height="${height}" viewBox="0 0 ${width} ${height}" role="img" aria-label="Updates over time total updates chart">
  <rect x="0" y="0" width="${width}" height="${height}" fill="#fff"/>
  ${yTickLines}
  <line x1="${margin.left}" y1="${margin.top + plotH}" x2="${width - margin.right}" y2="${margin.top + plotH}" stroke="#333"/>
  <line x1="${margin.left}" y1="${margin.top}" x2="${margin.left}" y2="${margin.top + plotH}" stroke="#333"/>
  ${xTicks}
  <polyline points="${points}" fill="none" stroke="#b0b0b0" stroke-width="1"/>
  ${data.map((d, i) => `<circle cx="${xPos(i)}" cy="${yPos(d.value)}" r="4" fill="#1a73e8"><title>${d.label}: ${d.value}</title></circle>`).join("")}
  <text x="${width / 2}" y="${height - 6}" text-anchor="middle" font-size="12" fill="#333">Time</text>
  <text x="16" y="${margin.top + (plotH / 2)}" text-anchor="middle" font-size="12" fill="#333" transform="rotate(-90 16 ${margin.top + (plotH / 2)})">Total Updates</text>
</svg>`;
                };

                window.renderUpdatesOverTimeChart = renderUpdatesOverTimeChart;
                window.addEventListener("resize", renderUpdatesOverTimeChart);
                renderUpdatesOverTimeChart();
            })();
        </script>
    }

    <h4>Year Breakdown</h4>
    @if (updateVelocity is null || updateVelocity.YearBreakdown.Count == 0)
    {
        <p>No yearly update data available.</p>
    }
    else
    {
        <table>
            <thead><tr><th>Year</th><th>Updates</th></tr></thead>
            <tbody>
            @foreach (var y in updateVelocity.YearBreakdown)
            {
                <tr>
                    <td>@y.Year</td>
                    <td>@y.UpdateCount</td>
                </tr>
            }
            </tbody>
        </table>
    }
</div>

<div id="tab-questions-answers" class="details-tab-panel card is-hidden">
    <h3>Questions &amp; Answers</h3>
    @if (Model.QuestionsAndAnswers.Count == 0)
    {
        <p>No stored question/answer rows yet.</p>
    }
    else
    {
        <table>
            <thead><tr><th>Question Time</th><th>Question By</th><th>Question</th><th>Answer Time</th><th>Answer By</th><th>Answer</th></tr></thead>
            <tbody>
            @foreach (var qa in Model.QuestionsAndAnswers)
            {
                <tr>
                    <td>@(qa.QuestionTimestampUtc?.ToString("dd MMM yyyy HH:mm") ?? qa.LastSeenUtc.ToString("dd MMM yyyy HH:mm"))</td>
                    <td>@(qa.QuestionProfileName ?? "N/A")</td>
                    <td>@(qa.QuestionText ?? "N/A")</td>
                    <td>@(qa.AnswerTimestampUtc?.ToString("dd MMM yyyy HH:mm") ?? "N/A")</td>
                    <td>@(qa.AnswerProfileName ?? "N/A")</td>
                    <td>@(qa.AnswerText ?? "N/A")</td>
                </tr>
            }
            </tbody>
        </table>
    }
</div>

<div id="tab-rank-history" class="details-tab-panel card is-hidden">
    <h3>Rank History</h3>
    <h4>Recent History</h4>
    <table>
    <thead><tr><th>Run</th><th>Keyword</th><th>Location</th><th>Rank</th><th>Avg Rating</th><th>Total Reviews</th><th>Captured</th></tr></thead>
    <tbody>
    @foreach (var h in Model.History)
    {
        <tr>
            <td><a href="/runs/@h.SearchRunId">@h.SearchRunId</a></td>
            <td>@(string.IsNullOrWhiteSpace(h.SeedKeyword) ? "N/A" : h.SeedKeyword)</td>
            <td>@(string.IsNullOrWhiteSpace(h.LocationName) ? "N/A" : h.LocationName)</td>
            <td>@h.RankPosition</td>
            <td>@h.Rating</td>
            <td>@h.UserRatingCount</td>
            <td>@h.CapturedAtUtc</td>
        </tr>
    }
    </tbody>
    </table>
</div>

<div id="tab-reports" class="details-tab-panel card is-hidden">
    <h3>Reports</h3>
    <div class="reports-list">
        <article class="reports-item">
            <div class="reports-item-header">
                <h4>First contact (1 page)</h4>
                <p class="muted">Local Visibility Snapshot</p>
            </div>
            @if (canViewFirstContactReport)
            {
                <div class="reports-actions">
                    <a class="btn btn-secondary" href="@firstContactClientUrl" target="_blank" rel="noopener noreferrer">View (Client-facing)</a>
                    <a class="btn btn-secondary" href="@firstContactInternalUrl" target="_blank" rel="noopener noreferrer">View (Internal)</a>
                </div>
                @if (!string.IsNullOrWhiteSpace(firstContactClientPdf) || !string.IsNullOrWhiteSpace(firstContactInternalPdf))
                {
                    <div class="reports-links">
                        @if (!string.IsNullOrWhiteSpace(firstContactClientPdf))
                        {
                            <a href="@firstContactClientPdf" target="_blank" rel="noopener noreferrer">Latest client-facing PDF</a>
                        }
                        @if (!string.IsNullOrWhiteSpace(firstContactInternalPdf))
                        {
                            <a href="@firstContactInternalPdf" target="_blank" rel="noopener noreferrer">Latest internal PDF</a>
                        }
                    </div>
                }
            }
            else
            {
                <div class="reports-actions">
                    <button type="button" class="btn btn-secondary" disabled>View (Client-facing)</button>
                    <button type="button" class="btn btn-secondary" disabled>View (Internal)</button>
                </div>
                <p class="muted">@reportBlockedMessage</p>
            }
        </article>
    </div>
</div>

@if (hasFinancialInfo)
{
    <div id="tab-financials" class="details-tab-panel card is-hidden">
        <div class="card-header">
            <h3 class="card-title">Financials</h3>
            <button type="button"
                    id="refresh-financials-button"
                    class="btn btn-secondary"
                    data-place-id="@Model.PlaceId"
                    data-company-number="@financialInfo!.CompanyNumber">
                Refresh
            </button>
        </div>
        <p id="financial-refresh-status" class="muted"></p>
        <div class="financial-overview-grid">
            <div class="financial-overview-item">
                <div class="financial-overview-label"><i class="bi bi-building" aria-hidden="true"></i> Company Number</div>
                <div class="financial-overview-value"><code>@financialInfo!.CompanyNumber</code></div>
            </div>
            <div class="financial-overview-item">
                <div class="financial-overview-label"><i class="bi bi-calendar-event" aria-hidden="true"></i> Date Incorporated</div>
                <div class="financial-overview-value">@FormatDateWithYearsAndMonths(financialInfo.DateOfCreation, todayDate)</div>
            </div>
            <div class="financial-overview-item financial-overview-item-wide @(nextAccountsDueIsOverdue ? "financial-overdue-card" : null)">
                <div class="financial-overview-label"><i class="bi bi-calendar2-range" aria-hidden="true"></i> Accounts Timeline</div>
                <div class="financial-overview-value">
                    <div class="financial-inline-pair">
                        <span><strong>Last Accounts Filed:</strong> @(financialInfo!.LastAccountsFiled?.ToString("dd MMM yyyy") ?? "N/A")</span>
                        <span class="financial-inline-separator">|</span>
                        <span class="@(nextAccountsDueIsOverdue ? "financial-overdue-text" : null)">
                            <strong>Next Accounts Due:</strong> @FormatNextAccountsDue(financialInfo.NextAccountsDue, todayDate)
                        </span>
                    </div>
                </div>
            </div>
            <div class="financial-overview-item financial-overview-item-wide">
                <div class="financial-overview-label"><i class="bi bi-shield-check" aria-hidden="true"></i> Company Status &amp; Flags</div>
                <div class="financial-overview-value">
                    <div class="financial-status-flags-line">
                        <span class="financial-status-line">
                            <span class="data-indicator @(companyIsActive ? "data-indicator-yes" : "data-indicator-no")" title="Company Status">@(companyIsActive ? "\u2713" : "\u2717")</span>
                            <span><strong>Status:</strong> @companyStatusDisplay</span>
                        </span>
                        <span class="financial-inline-separator">|</span>
                        <div class="financial-flags-inline">
                            <span class="financial-flag-item">
                                <span class="data-indicator @(financialInfo!.HasLiquidated ? "data-indicator-no" : "data-indicator-yes")" title="Has Liquidated">@(financialInfo.HasLiquidated ? "!" : "\u2713")</span>
                                @(financialInfo.HasLiquidated ? "Liquidated: Yes" : "Liquidated: No")
                            </span>
                            <span class="financial-flag-item">
                                <span class="data-indicator @(financialInfo!.HasCharges ? "data-indicator-no" : "data-indicator-yes")" title="Has Charges">@(financialInfo.HasCharges ? "!" : "\u2713")</span>
                                @(financialInfo.HasCharges ? "Charges: Yes" : "Charges: No")
                            </span>
                            <span class="financial-flag-item">
                                <span class="data-indicator @(financialInfo!.HasInsolvencyHistory ? "data-indicator-no" : "data-indicator-yes")" title="Has Insolvency History">@(financialInfo.HasInsolvencyHistory ? "!" : "\u2713")</span>
                                @(financialInfo.HasInsolvencyHistory ? "Insolvency History: Yes" : "Insolvency History: No")
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <h4 class="financial-section-title"><i class="bi bi-people-fill" aria-hidden="true"></i> Officers</h4>
        @if (Model.FinancialOfficers.Count == 0)
        {
            <p class="muted">No officer records were returned for this company.</p>
        }
        else
        {
            <div class="table-wrap">
                <table class="financial-table">
                    <thead>
                        <tr>
                            <th>First Names</th>
                            <th>Last Name</th>
                            <th>Country Of Residence</th>
                            <th>Date Of Birth</th>
                            <th>Nationality</th>
                            <th>Role</th>
                            <th>Appointed</th>
                            <th>Resigned</th>
                            <th>Possible Match</th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach (var officer in Model.FinancialOfficers)
                    {
                        var officerRowClass = string.Join(' ', new[]
                        {
                            officer.IsPossiblePscMatch ? "financial-linked-row" : null,
                            officer.Resigned.HasValue ? "financial-inactive-row" : null
                        }.Where(x => !string.IsNullOrWhiteSpace(x)));
                        <tr class="@officerRowClass">
                            <td>@(officer.LastName ?? "N/A")</td>
                            <td>@(officer.FirstNames ?? "N/A")</td>
                            <td>@(officer.CountryOfResidence ?? "N/A")</td>
                            <td>@FormatDateOfBirthWithAge(officer.DateOfBirth, todayDate)</td>
                            <td>@(officer.Nationality ?? "N/A")</td>
                            <td>@(officer.Role ?? "N/A")</td>
                            <td>@FormatAppointedWithTenure(officer.Appointed, officer.Resigned, todayDate)</td>
                            <td>@(officer.Resigned?.ToString("dd MMM yyyy") ?? "Active")</td>
                            <td>
                                @if (officer.IsPossiblePscMatch)
                                {
                                    <span class="status-pill status-ready financial-match-pill">PSC</span>
                                }
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        }

        <h4 class="financial-section-title"><i class="bi bi-person-vcard-fill" aria-hidden="true"></i> Persons with Significant Control</h4>
        @if (!hasFinancialPscs)
        {
            <p class="muted">No PSC records were returned for this company.</p>
        }
        else
        {
            <div class="table-wrap">
                <table class="financial-table financial-psc-table">
                    <thead>
                        <tr>
                            <th>First Names</th>
                            <th>Last Name</th>
                            <th>Country Of Residence</th>
                            <th>Date Of Birth</th>
                            <th>Active</th>
                            <th>Ownership Rights</th>
                            <th>Voting Rights</th>
                            <th>Appoint Directors</th>
                            <th>Significant Control</th>
                            <th>Trust Control</th>
                            <th>Firm Control</th>
                            <th>LLP Rights</th>
                            <th>Possible Match</th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach (var psc in Model.FinancialPersonsOfSignificantControl)
                    {
                        var pscRowClass = string.Join(' ', new[]
                        {
                            psc.IsPossibleOfficerMatch ? "financial-linked-row" : null,
                            psc.CeasedOn.HasValue ? "financial-inactive-row" : null
                        }.Where(x => !string.IsNullOrWhiteSpace(x)));
                        <tr class="@pscRowClass">
                            <td>@(psc.FirstNames ?? "N/A")</td>
                            <td>@(psc.LastName ?? "N/A")</td>
                            <td>@(psc.CountryOfResidence ?? "N/A")</td>
                            <td>@FormatPscDateOfBirth(psc.BirthMonth, psc.BirthYear, todayDate)</td>
                            <td>
                                <span class="data-indicator @(!psc.CeasedOn.HasValue ? "data-indicator-yes" : "data-indicator-no")" title="Active">@(!psc.CeasedOn.HasValue ? "\u2713" : "\u2717")</span>
                            </td>
                            <td>@psc.OwnershipRights</td>
                            <td>@psc.VotingRights</td>
                            <td>
                                <span class="data-indicator @(psc.CanAppointDirectors ? "data-indicator-yes" : "data-indicator-no")" title="Can Appoint Directors">@(psc.CanAppointDirectors ? "\u2713" : "\u2717")</span>
                            </td>
                            <td>
                                <span class="data-indicator @(psc.HasSignificantControl ? "data-indicator-yes" : "data-indicator-no")" title="Significant Control">@(psc.HasSignificantControl ? "\u2713" : "\u2717")</span>
                            </td>
                            <td>
                                <span class="data-indicator @(psc.HasTrustControl ? "data-indicator-yes" : "data-indicator-no")" title="Trust Control">@(psc.HasTrustControl ? "\u2713" : "\u2717")</span>
                            </td>
                            <td>
                                <span class="data-indicator @(psc.HasFirmControl ? "data-indicator-yes" : "data-indicator-no")" title="Firm Control">@(psc.HasFirmControl ? "\u2713" : "\u2717")</span>
                            </td>
                            <td>@psc.LlpRights</td>
                            <td>
                                @if (psc.IsPossibleOfficerMatch)
                                {
                                    <span class="status-pill status-ready financial-match-pill">Officer</span>
                                }
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        }

        <h4 class="financial-section-title"><i class="bi bi-file-earmark-text-fill" aria-hidden="true"></i> Accounts</h4>
        @if (!hasFinancialAccounts)
        {
            <p class="muted">No accounts documents downloaded yet.</p>
        }
        else
        {
            <div class="table-wrap">
                <table class="financial-table">
                    <thead>
                        <tr>
                            <th>Made Up / Filed</th>
                            <th>Accounts Type</th>
                            <th>File</th>
                            <th>Retrieved</th>
                            <th>Latest</th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach (var account in Model.FinancialAccounts)
                    {
                        <tr>
                            <td>@FormatAccountPeriodDate(account.MadeUpDate, account.FilingDate)</td>
                            <td>@(string.IsNullOrWhiteSpace(account.AccountsType) ? "N/A" : account.AccountsType)</td>
                            <td>
                                <a href="@Url.Content(account.LocalRelativePath)" target="_blank" rel="noopener noreferrer">
                                    @(string.IsNullOrWhiteSpace(account.OriginalFileName) ? account.DocumentId : account.OriginalFileName)
                                </a>
                            </td>
                            <td>@account.RetrievedUtc.ToString("dd MMM yyyy HH:mm")</td>
                            <td>
                                @if (account.IsLatest)
                                {
                                    <span class="status-pill status-ready financial-match-pill">Latest</span>
                                }
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        }
    </div>
}

<div id="tab-tech" class="details-tab-panel card is-hidden">
    <h3>Tech</h3>
    <div><strong>PlaceId:</strong> @Model.PlaceId</div>
    <div><strong>Lat:</strong> @(Model.Lat?.ToString() ?? "N/A")</div>
    <div><strong>Long:</strong> @(Model.Lng?.ToString() ?? "N/A")</div>
    <div><strong>Active Run:</strong> @(Model.ActiveRunId?.ToString() ?? "N/A")</div>
    <div><strong>Capturated At:</strong> @(Model.ActiveCapturedAtUtc?.ToString("dd MMM yyyy HH:mm") ?? "N/A")</div>
</div>

@if (!hasFinancialInfo)
{
    <div id="financial-modal" class="financial-modal-overlay is-hidden" aria-hidden="true">
        <div class="financial-modal-card" role="dialog" aria-modal="true" aria-labelledby="financial-modal-title">
            <div class="financial-modal-header">
                <h3 id="financial-modal-title">Select Company Financial Record</h3>
                <button type="button" class="btn btn-secondary" id="close-financial-modal-button">Close</button>
            </div>
            <form id="financial-search-form" class="financial-search-form">
                <label for="financial-search-query">Company name or company number</label>
                <div class="financial-search-row">
                    <input id="financial-search-query" type="text" value="@financialSearchDefault" maxlength="200" />
                </div>
                <label for="financial-search-location">Address or location (optional)</label>
                <div class="financial-search-row">
                    <input id="financial-search-location" type="text" value="@financialLocationDefault" maxlength="250" />
                    <button type="submit">Search</button>
                </div>
            </form>
            <p id="financial-search-status" class="muted">Search for a company and pick the best match.</p>
            <div class="table-wrap">
                <table id="financial-results-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Address</th>
                            <th>Date Incorporated</th>
                            <th>Company Number</th>
                            <th>Select</th>
                        </tr>
                    </thead>
                    <tbody id="financial-results-body"></tbody>
                </table>
            </div>
        </div>
    </div>
}

<script>
    (() => {
        const buttons = document.querySelectorAll("[data-tab-button]");
        const panels = document.querySelectorAll(".details-tab-panel");
        if (!buttons.length || !panels.length) return;

        const showTab = (tabKey) => {
            panels.forEach(panel => {
                if (panel.id === `tab-${tabKey}`) {
                    panel.classList.remove("is-hidden");
                } else {
                    panel.classList.add("is-hidden");
                }
            });
            buttons.forEach(button => {
                const key = button.getAttribute("data-tab-button");
                button.classList.toggle("is-active", key === tabKey);
            });
            if (tabKey === "reviews" && typeof window.renderReviewsOverTimeChart === "function") {
                window.renderReviewsOverTimeChart();
            }
            if (tabKey === "updates" && typeof window.renderUpdatesOverTimeChart === "function") {
                window.renderUpdatesOverTimeChart();
            }
        };

        buttons.forEach(button => {
            button.addEventListener("click", () => {
                const key = button.getAttribute("data-tab-button");
                if (!key) return;
                showTab(key);
            });
        });

        const requestedTab = new URLSearchParams(window.location.search).get("tab");
        const availableTabs = new Set(Array.from(buttons).map(x => x.getAttribute("data-tab-button")));
        showTab(requestedTab && availableTabs.has(requestedTab) ? requestedTab : "details");
    })();
</script>
@if (!hasFinancialInfo)
{
    <script>
        (() => {
            const openButton = document.getElementById("open-financial-modal-button");
            const closeButton = document.getElementById("close-financial-modal-button");
            const modal = document.getElementById("financial-modal");
            const searchForm = document.getElementById("financial-search-form");
            const searchInput = document.getElementById("financial-search-query");
            const locationInput = document.getElementById("financial-search-location");
            const searchStatus = document.getElementById("financial-search-status");
            const resultsBody = document.getElementById("financial-results-body");
            if (!openButton || !closeButton || !modal || !searchForm || !searchInput || !locationInput || !searchStatus || !resultsBody) return;

            const placeId = "@Model.PlaceId";
            let lastResults = [];
            let isSaving = false;

            const formatDate = (value) => {
                if (!value) return "N/A";
                const parsed = new Date(value);
                if (Number.isNaN(parsed.getTime())) return value;
                return parsed.toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" });
            };

            const setStatus = (message, isError) => {
                searchStatus.textContent = message;
                searchStatus.classList.toggle("financial-error-text", !!isError);
            };

            const openModal = () => {
                modal.classList.remove("is-hidden");
                modal.setAttribute("aria-hidden", "false");
                document.body.classList.add("modal-open");
                searchInput.focus();
                searchInput.select();
                runSearch();
            };

            const closeModal = () => {
                modal.classList.add("is-hidden");
                modal.setAttribute("aria-hidden", "true");
                document.body.classList.remove("modal-open");
            };

            const clearResults = () => {
                resultsBody.innerHTML = "";
                lastResults = [];
            };

            const renderResults = (rows) => {
                clearResults();
                if (!rows || rows.length === 0) {
                    setStatus("No companies found for this query.", false);
                    return;
                }

                const fragment = document.createDocumentFragment();
                rows.forEach((row, index) => {
                    const tr = document.createElement("tr");

                    const titleCell = document.createElement("td");
                    titleCell.textContent = row.title || "N/A";
                    tr.appendChild(titleCell);

                    const addressCell = document.createElement("td");
                    addressCell.textContent = row.address || "N/A";
                    tr.appendChild(addressCell);

                    const dateCell = document.createElement("td");
                    dateCell.textContent = formatDate(row.dateOfCreation);
                    tr.appendChild(dateCell);

                    const numberCell = document.createElement("td");
                    numberCell.textContent = row.companyNumber || "N/A";
                    tr.appendChild(numberCell);

                    const actionCell = document.createElement("td");
                    const selectButton = document.createElement("button");
                    selectButton.type = "button";
                    selectButton.className = "btn btn-secondary";
                    selectButton.dataset.rowIndex = index.toString();
                    selectButton.textContent = "Select";
                    actionCell.appendChild(selectButton);
                    tr.appendChild(actionCell);

                    fragment.appendChild(tr);
                });

                resultsBody.appendChild(fragment);
                lastResults = rows;
                setStatus(`Found ${rows.length} result(s). Select one to import full financial data.`, false);
            };

            const runSearch = async () => {
                const query = searchInput.value.trim();
                const location = locationInput.value.trim();
                if (!query && !location) {
                    clearResults();
                    setStatus("Enter a company name, company number, or address first.", true);
                    return;
                }

                setStatus("Searching Companies House...", false);
                clearResults();

                try {
                    const response = await fetch(
                        `/api/companies-house/search?q=${encodeURIComponent(query)}&location=${encodeURIComponent(location)}`,
                        {
                            method: "GET",
                            credentials: "same-origin"
                        });

                    if (!response.ok) {
                        setStatus("Search failed. Please try again.", true);
                        return;
                    }

                    const rows = await response.json();
                    renderResults(Array.isArray(rows) ? rows : []);
                } catch {
                    setStatus("Search failed. Please try again.", true);
                }
            };

            const saveSelection = async (rowIndex) => {
                if (isSaving) return;
                const selected = lastResults[rowIndex];
                if (!selected || !selected.companyNumber) {
                    setStatus("Selected row is invalid.", true);
                    return;
                }

                isSaving = true;
                setStatus("Importing full financial profile from Companies House...", false);

                try {
                    const response = await fetch(`/api/places/${encodeURIComponent(placeId)}/financial/refresh`, {
                        method: "POST",
                        credentials: "same-origin",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            companyNumber: selected.companyNumber
                        })
                    });

                    if (!response.ok) {
                        setStatus("Import failed. Please try again.", true);
                        isSaving = false;
                        return;
                    }

                    closeModal();
                    window.location.reload();
                } catch {
                    setStatus("Import failed. Please try again.", true);
                    isSaving = false;
                }
            };

            openButton.addEventListener("click", openModal);
            closeButton.addEventListener("click", closeModal);

            modal.addEventListener("click", (event) => {
                if (event.target === modal) closeModal();
            });

            document.addEventListener("keydown", (event) => {
                if (event.key === "Escape" && !modal.classList.contains("is-hidden"))
                    closeModal();
            });

            searchForm.addEventListener("submit", (event) => {
                event.preventDefault();
                runSearch();
            });

            resultsBody.addEventListener("click", (event) => {
                const target = event.target;
                if (!(target instanceof HTMLElement)) return;
                const button = target.closest("button[data-row-index]");
                if (!button) return;
                const rowIndex = Number.parseInt(button.dataset.rowIndex || "", 10);
                if (Number.isNaN(rowIndex)) return;
                saveSelection(rowIndex);
            });
        })();
    </script>
}
@if (hasFinancialInfo)
{
    <script>
        (() => {
            const refreshButton = document.getElementById("refresh-financials-button");
            const status = document.getElementById("financial-refresh-status");
            if (!refreshButton || !status) return;

            let isRefreshing = false;
            const companyNumber = refreshButton.getAttribute("data-company-number") || "";
            const placeId = refreshButton.getAttribute("data-place-id") || "";

            const setStatus = (message, isError) => {
                status.textContent = message;
                status.classList.toggle("financial-error-text", !!isError);
            };

            refreshButton.addEventListener("click", async () => {
                if (isRefreshing) return;
                if (!placeId || !companyNumber) {
                    setStatus("Company number is missing.", true);
                    return;
                }

                isRefreshing = true;
                refreshButton.setAttribute("disabled", "disabled");
                setStatus("Refreshing financial profile from Companies House...", false);

                try {
                    const response = await fetch(`/api/places/${encodeURIComponent(placeId)}/financial/refresh`, {
                        method: "POST",
                        credentials: "same-origin",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            companyNumber
                        })
                    });

                    if (!response.ok) {
                        setStatus("Refresh failed. Please try again.", true);
                        isRefreshing = false;
                        refreshButton.removeAttribute("disabled");
                        return;
                    }

                    window.location.reload();
                } catch {
                    setStatus("Refresh failed. Please try again.", true);
                    isRefreshing = false;
                    refreshButton.removeAttribute("disabled");
                }
            });
        })();
    </script>
}
</div>

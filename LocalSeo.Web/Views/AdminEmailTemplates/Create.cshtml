@model EmailTemplateEditViewModel
@{
    ViewData["Title"] = "Create Email Template";
}

<div class="page-stack">
    @if (!string.IsNullOrWhiteSpace(Model.Message))
    {
        <div class="notice">@Model.Message</div>
    }

    <section class="card">
        <div class="toolbar">
            <a href="/admin/email-templates" class="btn btn-secondary">Back to Email Templates</a>
        </div>
    </section>

    <section class="card">
        <h2 class="card-title">Create Template</h2>
        <form method="post" action="/admin/email-templates/create" class="form-grid">
            @Html.AntiForgeryToken()

            <label for="template-key">Key</label>
            <input id="template-key" name="Key" type="text" maxlength="100" value="@Model.Template.Key" required />

            <label for="template-name">Name</label>
            <input id="template-name" name="Name" type="text" maxlength="200" value="@Model.Template.Name" required />

            <label for="template-from-name">From Name</label>
            <input id="template-from-name" name="FromName" type="text" maxlength="200" value="@Model.Template.FromName" />

            <label for="template-from-email">From Email</label>
            <input id="template-from-email" name="FromEmail" type="email" maxlength="320" value="@Model.Template.FromEmail" required />

            <label for="template-subject">Subject Template</label>
            <textarea id="template-subject" name="SubjectTemplate" rows="3" required>@Model.Template.SubjectTemplate</textarea>

            <label for="template-body">Body HTML Template</label>
            <div class="wysiwyg-wrap js-wysiwyg">
                <div class="wysiwyg-toolbar">
                    <button type="button" class="btn btn-secondary" data-cmd="bold"><strong>B</strong></button>
                    <button type="button" class="btn btn-secondary" data-cmd="italic"><em>I</em></button>
                    <button type="button" class="btn btn-secondary" data-cmd="underline"><u>U</u></button>
                    <button type="button" class="btn btn-secondary" data-cmd="insertUnorderedList">Bullets</button>
                    <button type="button" class="btn btn-secondary" data-cmd="insertOrderedList">Numbers</button>
                    <button type="button" class="btn btn-secondary" data-cmd="createLink">Link</button>
                    <button type="button" class="btn btn-secondary" data-cmd="removeFormat">Clear</button>
                </div>
                <div id="template-body-editor" class="wysiwyg-editor" contenteditable="true"></div>
                <textarea id="template-body" name="BodyHtmlTemplate" rows="14" class="wysiwyg-source" required>@Model.Template.BodyHtmlTemplate</textarea>
                <p class="muted">Use the editor above for basic formatting. HTML is still stored in the template.</p>
            </div>

            <label class="checkbox-inline">
                <input type="checkbox" name="IsSensitive" value="true" @(Model.Template.IsSensitive ? "checked" : null) />
                <span>Sensitive template (store only redacted output in logs)</span>
            </label>

            <label class="checkbox-inline">
                <input type="checkbox" name="IsEnabled" value="true" @(Model.Template.IsEnabled ? "checked" : null) />
                <span>Enabled</span>
            </label>

            <div class="toolbar">
                <button type="submit" class="btn btn-primary">Create Template</button>
                <a class="btn btn-secondary" href="/admin/email-templates">Cancel</a>
            </div>
        </form>
    </section>

    <section class="card">
        <h2 class="card-title">Available Tokens</h2>
        @if (Model.AvailableTokens.Count == 0)
        {
            <p class="muted">No token hints for this key yet.</p>
        }
        else
        {
            <ul>
                @foreach (var token in Model.AvailableTokens)
                {
                    <li><code>[%@token%]</code></li>
                }
            </ul>
        }
    </section>
</div>

<script>
(() => {
    const container = document.querySelector('.js-wysiwyg');
    if (!container) return;
    const editor = container.querySelector('.wysiwyg-editor');
    const source = container.querySelector('.wysiwyg-source');
    if (!editor || !source) return;

    editor.innerHTML = source.value || '';
    const sync = () => { source.value = editor.innerHTML; };

    container.querySelectorAll('[data-cmd]').forEach(btn => {
        btn.addEventListener('click', () => {
            const cmd = btn.getAttribute('data-cmd');
            if (!cmd) return;

            if (cmd === 'createLink') {
                const url = window.prompt('Enter the URL');
                if (!url) return;
                document.execCommand(cmd, false, url.trim());
            } else {
                document.execCommand(cmd, false, null);
            }

            sync();
            editor.focus();
        });
    });

    editor.addEventListener('input', sync);
    const form = container.closest('form');
    if (form) form.addEventListener('submit', sync);
})();
</script>

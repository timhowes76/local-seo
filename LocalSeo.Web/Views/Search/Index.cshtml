@using System.Globalization
@model SearchFormModel
@{
    ViewData["Title"] = "Search";
    var statusMessage = TempData["Status"] as string;
    var isRerun = Model.RerunSourceRunId.HasValue;
    var keyphrases = Model.Keyphrases;
    string FormatMonthYear(int year, int month)
    {
        if (month < 1 || month > 12)
        {
            return $"{year}-{month:00}";
        }

        return new DateTime(year, month, 1).ToString("MMM yyyy", CultureInfo.InvariantCulture);
    }
}
<div class="page-stack">
    @if (!string.IsNullOrWhiteSpace(statusMessage))
    {
        <div class="notice">@statusMessage</div>
    }

    @if (isRerun)
    {
        <div class="notice">
            Rerun mode from <a href="/runs/@Model.RerunSourceRunId">Run #@Model.RerunSourceRunId</a>. You can change data enrichment options before starting.
        </div>
    }

    <section class="card">
        <h2 class="card-title">Run Google Places Search</h2>
        @Html.ValidationSummary(false)
        <form method="post" action="/search" class="form-grid" id="search-form">
            @Html.AntiForgeryToken()
            <input asp-for="RerunSourceRunId" type="hidden" />
            <div class="form-row">
                <label asp-for="CategoryId">Google Business Profile Category</label>
                <select asp-for="CategoryId" class="js-searchable" data-placeholder="Search" required>
                    <option value=""></option>
                    @foreach (var category in Model.CategoryOptions)
                    {
                        if (string.Equals(category.CategoryId, Model.CategoryId, StringComparison.OrdinalIgnoreCase))
                        {
                            <option value="@category.CategoryId" selected>@category.DisplayName (@category.CategoryId)</option>
                        }
                        else
                        {
                            <option value="@category.CategoryId">@category.DisplayName (@category.CategoryId)</option>
                        }
                    }
                </select>
                @Html.ValidationMessageFor(x => x.CategoryId)
            </div>
            <div class="search-location-row">
                <div class="form-row">
                    <label asp-for="CountyId">County</label>
                    <select asp-for="CountyId" id="CountyId" class="js-searchable" data-placeholder="Search" required>
                        <option value=""></option>
                        @foreach (var county in Model.CountyOptions)
                        {
                            if (Model.CountyId.HasValue && county.CountyId == Model.CountyId.Value)
                            {
                                <option value="@county.CountyId" selected>@county.Name</option>
                            }
                            else
                            {
                                <option value="@county.CountyId">@county.Name</option>
                            }
                        }
                    </select>
                    @Html.ValidationMessageFor(x => x.CountyId)
                </div>
                <div class="form-row">
                    <label asp-for="TownId">Town</label>
                    <select asp-for="TownId" id="TownId" class="js-searchable" data-placeholder="Search" required>
                        <option value=""></option>
                        @foreach (var town in Model.TownOptions)
                        {
                            if (Model.TownId.HasValue && town.TownId == Model.TownId.Value)
                            {
                                <option value="@town.TownId" selected>@town.Name</option>
                            }
                            else
                            {
                                <option value="@town.TownId">@town.Name</option>
                            }
                        }
                    </select>
                    @Html.ValidationMessageFor(x => x.TownId)
                </div>
            </div>
            <div class="form-row">
                <label for="RadiusKm">Radius</label>
                <input id="RadiusKm" name="RadiusKm" type="range" min="1" max="100" step="1" value="@Math.Max(1, Model.RadiusMeters / 1000)" />
                <span id="RadiusKmDisplay" class="muted">@Math.Max(1, Model.RadiusMeters / 1000) KM</span>
                <input asp-for="RadiusMeters" type="hidden" />
            </div>
            <div class="form-row">
                <label asp-for="ResultLimit">Search Depth</label>
                <input asp-for="ResultLimit" min="1" max="20" />
            </div>
            <div class="inline-group">
                <input asp-for="FetchEnhancedGoogleData" type="checkbox" />
                <label asp-for="FetchEnhancedGoogleData">Get Enhanced Google Data (Description, Topics, Other Categories)</label>
            </div>
            <div class="inline-group">
                <input asp-for="FetchGoogleReviews" type="checkbox" />
                <label asp-for="FetchGoogleReviews">Get Google Reviews</label>
            </div>
            <div class="inline-group">
                <input asp-for="FetchGoogleUpdates" type="checkbox" />
                <label asp-for="FetchGoogleUpdates">Get Google Updates</label>
            </div>
            <div class="inline-group">
                <input asp-for="FetchGoogleQuestionsAndAnswers" type="checkbox" />
                <label asp-for="FetchGoogleQuestionsAndAnswers">Get Google Question &amp; Answers</label>
            </div>
            <div class="inline-group">
                <input asp-for="FetchGoogleSocialProfiles" type="checkbox" />
                <label asp-for="FetchGoogleSocialProfiles">Get Social Profiles</label>
            </div>
            <div>
                <button type="submit" id="run-search-btn">Run Search</button>
                <button type="button" id="view-keyphrases-btn" class="btn btn-secondary">View Keyphrases for Selection</button>
            </div>
        </form>
    </section>

    @if (!string.IsNullOrWhiteSpace(Model.KeyphrasesError))
    {
        <section class="card">
            <h2 class="card-title">Keyphrases</h2>
            <p class="muted">@Model.KeyphrasesError</p>
        </section>
    }
    else if (keyphrases is not null)
    {
        <section class="card">
            <div class="toolbar">
                <h2 class="card-title">Keyphrases for @keyphrases.LocationName, @keyphrases.CountyName</h2>
                <form method="post" action="/search/keyphrases/refresh-eligible">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="categoryId" value="@Model.CategoryId" />
                    <input type="hidden" name="countyId" value="@(Model.CountyId ?? 0)" />
                    <input type="hidden" name="townId" value="@(Model.TownId ?? 0)" />
                    <button type="submit" class="btn btn-secondary">Refresh Eligible</button>
                </form>
            </div>
            <p class="muted">Category: @keyphrases.CategoryDisplayName</p>
            <p class="muted">Refresh cooldown: @keyphrases.SearchVolumeRefreshCooldownDays day(s)</p>
        </section>

        <section class="card">
            <h2 class="card-title">Add New Keyphrase</h2>
            <form id="SearchKeyphraseAddForm" method="post" action="/search/keyphrases/add" class="form-grid">
                @Html.AntiForgeryToken()
                <input type="hidden" name="categoryId" value="@Model.CategoryId" />
                <input type="hidden" name="countyId" value="@(Model.CountyId ?? 0)" />
                <input type="hidden" name="townId" value="@(Model.TownId ?? 0)" />
                <input id="SearchExpectedMainKeyword" type="hidden" value="@keyphrases.ExpectedMainKeyword" />
                <input id="SearchRequiredLocationName" type="hidden" value="@keyphrases.LocationName" />
                <div class="form-row">
                    <label for="SearchKeyphraseKeyword">Keyword</label>
                    <input id="SearchKeyphraseKeyword" name="Keyword" type="text" value="@keyphrases.AddForm.Keyword" maxlength="255" required />
                    <div id="SearchKeywordValidationMessage" class="form-help form-help-error is-hidden"></div>
                </div>
                <div class="form-row">
                    <label>Keyword Type</label>
                    <div class="inline-group">
                        <input id="SearchKeywordTypeMain" name="KeywordType" type="radio" value="@CategoryLocationKeywordTypes.MainTerm" @(keyphrases.AddForm.KeywordType == CategoryLocationKeywordTypes.MainTerm ? "checked" : null) />
                        <label for="SearchKeywordTypeMain">Main Term</label>
                    </div>
                    <div class="inline-group">
                        <input id="SearchKeywordTypeModifier" name="KeywordType" type="radio" value="@CategoryLocationKeywordTypes.Modifier" @(keyphrases.AddForm.KeywordType == CategoryLocationKeywordTypes.Modifier ? "checked" : null) />
                        <label for="SearchKeywordTypeModifier">Modifier</label>
                    </div>
                    <div class="inline-group">
                        <input id="SearchKeywordTypeAdjacent" name="KeywordType" type="radio" value="@CategoryLocationKeywordTypes.Adjacent" @(keyphrases.AddForm.KeywordType == CategoryLocationKeywordTypes.Adjacent ? "checked" : null) />
                        <label for="SearchKeywordTypeAdjacent">Adjacent</label>
                    </div>
                    <p id="SearchMainTermRuleText" class="form-help">Main Term is only available when the keyword exactly matches "@keyphrases.ExpectedMainKeyword".</p>
                    <div class="help-panel">
                        <p class="help-panel-title">Search Term Modelling</p>
                        <p>We estimate total local search demand by combining different types of search phrases people use when looking for your service.</p>
                        <p>We group terms into three types:</p>
                        <p><strong>Main Term</strong><br />Your core service + location.<br />Example: Hairdresser Yeovil</p>
                        <p>This is the primary phrase most directly describing your business.</p>
                        <p><strong>Modifiers</strong><br />Variations that show specific intent or preferences.<br />Examples:</p>
                        <ul>
                            <li>cheap hairdresser yeovil</li>
                            <li>best hairdresser yeovil</li>
                            <li>walk in hairdresser yeovil</li>
                            <li>ladies hairdresser yeovil</li>
                        </ul>
                        <p>These often indicate higher buying intent and can represent significant additional demand.</p>
                        <p><strong>Adjacent Terms</strong><br />Closely related services customers may also consider.<br />Examples:</p>
                        <ul>
                            <li>barber yeovil</li>
                            <li>beauty salon yeovil</li>
                            <li>nail salon yeovil</li>
                        </ul>
                        <p>These show nearby commercial demand and potential crossover opportunities.</p>
                        <p><strong>Why this matters</strong></p>
                        <p>Customers do not all search using the same phrase. By combining core, modified, and related terms, we create a more realistic estimate of total market opportunity in your area.</p>
                    </div>
                </div>
                <div class="toolbar">
                    <button type="submit">Add Keyphrase + Fetch Volume</button>
                </div>
            </form>
        </section>

        <section class="card">
            <h2 class="card-title">Keyphrases</h2>
            @if (keyphrases.Rows.Count == 0)
            {
                <p class="muted">No keyphrases added yet.</p>
            }
            else
            {
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Keyword</th>
                                <th>Keyword Type</th>
                                <th>Synonym Of</th>
                                <th>Avg Search Volume</th>
                                <th>Data</th>
                                <th>Search Volume (Last 12 Months)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var row in keyphrases.Rows)
                        {
                            var keywordTypeLabel = row.KeywordType switch
                            {
                                1 => "MainTerm",
                                2 => "Synonym",
                                3 => "Modifier",
                                4 => "Adjacent",
                                _ => "Unknown"
                            };
                            var hasData = !row.NoData && row.AvgSearchVolume.HasValue;
                            var maxVolume = row.Last12Months.Count == 0 ? 0 : row.Last12Months.Max(x => x.SearchVolume);
                            <tr>
                                <td>@row.Keyword</td>
                                <td>@keywordTypeLabel</td>
                                <td>@(row.KeywordType == CategoryLocationKeywordTypes.Synonym && !string.IsNullOrWhiteSpace(row.SynonymOfKeyword) ? row.SynonymOfKeyword : "-")</td>
                                <td>@(row.AvgSearchVolume?.ToString("N0") ?? "N/A")</td>
                                <td>
                                    @if (hasData)
                                    {
                                        <span class="data-indicator data-indicator-yes" aria-label="Data available">&#10003;</span>
                                    }
                                    else
                                    {
                                        <span class="data-indicator data-indicator-no" aria-label="No data">&#10007;</span>
                                    }
                                </td>
                                <td>
                                    @if (row.Last12Months.Count == 0)
                                    {
                                        <span class="muted">No monthly data</span>
                                    }
                                    else
                                    {
                                        <div class="sparkline">
                                            @foreach (var point in row.Last12Months)
                                            {
                                                var heightPercent = maxVolume <= 0 ? 0 : Math.Max(5, (int)Math.Round((point.SearchVolume * 100.0) / maxVolume));
                                                <span class="sparkline-bar" title="@point.Year-@point.Month.ToString("00"): @point.SearchVolume" style="height:@heightPercent%"></span>
                                            }
                                        </div>
                                        <div class="muted">
                                            Data as of: @(row.DataAsOfUtc?.ToString("MMM yyyy", CultureInfo.InvariantCulture) ?? "N/A")
                                        </div>
                                    }
                                </td>
                                <td>
                                    <div class="toolbar">
                                        @if (row.IsRefreshEligible)
                                        {
                                            <form method="post" action="/search/keyphrases/@row.Id/refresh">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="categoryId" value="@Model.CategoryId" />
                                                <input type="hidden" name="countyId" value="@(Model.CountyId ?? 0)" />
                                                <input type="hidden" name="townId" value="@(Model.TownId ?? 0)" />
                                                <button type="submit" class="btn btn-secondary">Refresh</button>
                                            </form>
                                        }
                                        @if (row.KeywordType != CategoryLocationKeywordTypes.MainTerm && row.KeywordType != CategoryLocationKeywordTypes.Adjacent)
                                        {
                                            <form method="post" action="/search/keyphrases/@row.Id/set-type">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="keywordType" value="@CategoryLocationKeywordTypes.Adjacent" />
                                                <input type="hidden" name="categoryId" value="@Model.CategoryId" />
                                                <input type="hidden" name="countyId" value="@(Model.CountyId ?? 0)" />
                                                <input type="hidden" name="townId" value="@(Model.TownId ?? 0)" />
                                                <button type="submit" class="btn btn-secondary">Set Adjacent</button>
                                            </form>
                                        }
                                        @if (row.KeywordType == CategoryLocationKeywordTypes.Adjacent)
                                        {
                                            <form method="post" action="/search/keyphrases/@row.Id/set-type">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="keywordType" value="@CategoryLocationKeywordTypes.Modifier" />
                                                <input type="hidden" name="categoryId" value="@Model.CategoryId" />
                                                <input type="hidden" name="countyId" value="@(Model.CountyId ?? 0)" />
                                                <input type="hidden" name="townId" value="@(Model.TownId ?? 0)" />
                                                <button type="submit" class="btn btn-secondary">Set Modifier</button>
                                            </form>
                                        }
                                        <form method="post" action="/search/keyphrases/@row.Id/delete" onsubmit="return confirm('Delete this keyphrase and its monthly data?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="categoryId" value="@Model.CategoryId" />
                                            <input type="hidden" name="countyId" value="@(Model.CountyId ?? 0)" />
                                            <input type="hidden" name="townId" value="@(Model.TownId ?? 0)" />
                                            <button type="submit" class="btn btn-secondary">Delete</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            }
        </section>

        <section class="card">
            <h2 class="card-title">Total Search Volume (Last 12 Months)</h2>
            @if (keyphrases.WeightedTotalLast12Months.Count == 0)
            {
                <p class="muted">No monthly data available yet.</p>
            }
            else
            {
                var maxTotal = keyphrases.WeightedTotalLast12Months.Max(x => x.WeightedSearchVolume);
                <div class="volume-chart">
                    @foreach (var point in keyphrases.WeightedTotalLast12Months)
                    {
                        var heightPercent = maxTotal <= 0 ? 0 : Math.Max(5, (int)Math.Round((point.WeightedSearchVolume * 100m) / maxTotal));
                        var monthLabel = FormatMonthYear(point.Year, point.Month);
                        <div class="volume-chart-column">
                            <div class="volume-chart-plot">
                                <span class="volume-chart-bar" style="height:@heightPercent%" title="@monthLabel: @point.WeightedSearchVolume.ToString("N1")"></span>
                            </div>
                            <span class="volume-chart-label">@monthLabel</span>
                            <span class="volume-chart-value">@point.WeightedSearchVolume.ToString("N0")</span>
                        </div>
                    }
                </div>
            }
            <p class="muted">Calculated as Main Term monthly volume plus 70% of each Modifier and Adjacent monthly volume. Synonyms are excluded to avoid double counting.</p>
        </section>
    }
</div>

<div id="search-loading-overlay" class="loading-overlay is-hidden" role="dialog" aria-live="polite" aria-modal="true" aria-label="Search is running">
    <div class="loading-modal">
        <div class="loading-spinner" aria-hidden="true"></div>
        <h3>Running Search</h3>
        <p>Please wait while we gather places and enrichment data.</p>
    </div>
</div>

<script>
    (() => {
        const kmSlider = document.getElementById("RadiusKm");
        const metersInput = document.getElementById("RadiusMeters");
        const kmDisplay = document.getElementById("RadiusKmDisplay");
        const form = document.getElementById("search-form");
        const runButton = document.getElementById("run-search-btn");
        const loadingOverlay = document.getElementById("search-loading-overlay");
        const countySelect = document.getElementById("CountyId");
        const townSelect = document.getElementById("TownId");
        const categorySelect = document.getElementById("CategoryId");
        const viewKeyphrasesButton = document.getElementById("view-keyphrases-btn");
        const keyphraseAddForm = document.getElementById("SearchKeyphraseAddForm");
        const keyphraseInput = document.getElementById("SearchKeyphraseKeyword");
        const keyphraseMainType = document.getElementById("SearchKeywordTypeMain");
        const keyphraseModifierType = document.getElementById("SearchKeywordTypeModifier");
        const keyphraseExpectedMain = document.getElementById("SearchExpectedMainKeyword")?.value ?? "";
        const keyphraseRequiredLocation = document.getElementById("SearchRequiredLocationName")?.value ?? "";
        const keyphraseMainRuleText = document.getElementById("SearchMainTermRuleText");
        const keyphraseValidationMessage = document.getElementById("SearchKeywordValidationMessage");
        const initialTownId = "@(Model.TownId?.ToString() ?? string.Empty)";
        const rerunId = "@(Model.RerunSourceRunId?.ToString() ?? string.Empty)";
        if (!kmSlider || !metersInput || !kmDisplay) return;

        const syncFromKm = () => {
            const km = Number(kmSlider.value || "1");
            const meters = Math.max(1000, km * 1000);
            metersInput.value = String(meters);
            kmDisplay.textContent = `${km} KM`;
        };

        const showLoadingState = () => {
            if (runButton instanceof HTMLButtonElement) {
                runButton.disabled = true;
                runButton.textContent = "Running...";
            }
            if (loadingOverlay) {
                loadingOverlay.classList.remove("is-hidden");
            }
        };

        if (form instanceof HTMLFormElement) {
            form.addEventListener("submit", () => {
                showLoadingState();
            });
        }

        const buildTownOption = (town, selectedTownId) => {
            const option = document.createElement("option");
            option.value = String(town.townId);
            option.textContent = town.name;
            if (selectedTownId && String(town.townId) === String(selectedTownId)) {
                option.selected = true;
            }
            return option;
        };

        const resetTownOptions = () => {
            if (!(townSelect instanceof HTMLSelectElement)) return;
            if (townSelect.tomselect) {
                townSelect.tomselect.clear(true);
                townSelect.tomselect.clearOptions();
                townSelect.tomselect.addOption({ value: "", text: "" });
                townSelect.tomselect.setValue("", true);
                townSelect.tomselect.refreshOptions(false);
                return;
            }
            townSelect.innerHTML = "";
            const placeholder = document.createElement("option");
            placeholder.value = "";
            placeholder.textContent = "";
            townSelect.appendChild(placeholder);
        };

        const loadTowns = async (selectedTownId) => {
            if (!(countySelect instanceof HTMLSelectElement) || !(townSelect instanceof HTMLSelectElement)) return;
            const countyId = countySelect.value;
            resetTownOptions();
            if (!countyId) return;

            try {
                const response = await fetch(`/search/towns?countyId=${encodeURIComponent(countyId)}`, {
                    headers: { "Accept": "application/json" }
                });
                if (!response.ok) return;
                const towns = await response.json();
                if (townSelect.tomselect) {
                    for (const town of towns) {
                        townSelect.tomselect.addOption({
                            value: String(town.townId),
                            text: town.name
                        });
                    }
                    if (selectedTownId) {
                        townSelect.tomselect.setValue(String(selectedTownId), true);
                    }
                    townSelect.tomselect.refreshOptions(false);
                } else {
                    for (const town of towns) {
                        townSelect.appendChild(buildTownOption(town, selectedTownId));
                    }
                }
            } catch {
                // Ignore and keep form usable without dynamic loading.
            }
        };

        if (countySelect instanceof HTMLSelectElement) {
            countySelect.addEventListener("change", () => {
                loadTowns("");
            });

            if (countySelect.value && (!(townSelect instanceof HTMLSelectElement) || townSelect.options.length <= 1)) {
                loadTowns(initialTownId);
            }
        }

        if (viewKeyphrasesButton instanceof HTMLButtonElement) {
            viewKeyphrasesButton.addEventListener("click", () => {
                const query = new URLSearchParams();
                const categoryId = categorySelect instanceof HTMLSelectElement ? categorySelect.value : "";
                const countyId = countySelect instanceof HTMLSelectElement ? countySelect.value : "";
                const townId = townSelect instanceof HTMLSelectElement ? townSelect.value : "";
                if (rerunId) query.set("rerunId", rerunId);
                if (categoryId) query.set("categoryId", categoryId);
                if (countyId) query.set("countyId", countyId);
                if (townId) query.set("townId", townId);
                window.location.href = query.toString() ? `/search?${query}` : "/search";
            });
        }

        const normalizeKeyword = (value) =>
            (value || "")
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, " ")
                .trim()
                .replace(/\s+/g, " ");

        const normalizedExpectedMain = normalizeKeyword(keyphraseExpectedMain);
        const normalizedRequiredLocation = normalizeKeyword(keyphraseRequiredLocation);

        const setKeyphraseValidationMessage = (message) => {
            if (!keyphraseValidationMessage) return;
            if (!message) {
                keyphraseValidationMessage.textContent = "";
                keyphraseValidationMessage.classList.add("is-hidden");
                return;
            }
            keyphraseValidationMessage.textContent = message;
            keyphraseValidationMessage.classList.remove("is-hidden");
        };

        const updateKeyphraseMainAvailability = () => {
            const normalizedKeyword = normalizeKeyword(keyphraseInput?.value);
            const canSelectMain = normalizedKeyword.length > 0 && normalizedKeyword === normalizedExpectedMain;
            if (keyphraseMainType) {
                keyphraseMainType.disabled = !canSelectMain;
                if (!canSelectMain && keyphraseMainType.checked && keyphraseModifierType) {
                    keyphraseModifierType.checked = true;
                }
            }
            if (keyphraseMainRuleText) {
                keyphraseMainRuleText.textContent = canSelectMain
                    ? "Main Term can be selected for this keyword."
                    : `Main Term is only available when the keyword exactly matches "${keyphraseExpectedMain}".`;
            }
            return canSelectMain;
        };

        keyphraseInput?.addEventListener("input", () => {
            updateKeyphraseMainAvailability();
            setKeyphraseValidationMessage("");
        });

        if (keyphraseAddForm instanceof HTMLFormElement) {
            keyphraseAddForm.addEventListener("submit", (event) => {
                const normalizedKeyword = normalizeKeyword(keyphraseInput?.value);
                const hasLocation = normalizedRequiredLocation.length > 0
                    && (` ${normalizedKeyword} `).includes(` ${normalizedRequiredLocation} `);
                if (!hasLocation) {
                    event.preventDefault();
                    setKeyphraseValidationMessage(`Please include the location "${keyphraseRequiredLocation}" in the keyphrase.`);
                    return;
                }
                if (keyphraseMainType?.checked && !updateKeyphraseMainAvailability()) {
                    event.preventDefault();
                    setKeyphraseValidationMessage(`Main Term is only allowed when the keyphrase exactly matches "${keyphraseExpectedMain}".`);
                    return;
                }
                setKeyphraseValidationMessage("");
            });
        }

        updateKeyphraseMainAvailability();

        kmSlider.addEventListener("input", syncFromKm);
        syncFromKm();
    })();
</script>


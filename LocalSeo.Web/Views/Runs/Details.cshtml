@using System.Text.Json
@inject Microsoft.Extensions.Options.IOptions<LocalSeo.Web.Options.GoogleOptions> GoogleOptions
@model RunDetailsViewModel
@{
    ViewData["Title"] = $"Run {Model.Run.SearchRunId}";
    string StatusCss(string? value, string fallback)
    {
        var key = (value ?? fallback).Trim().ToLowerInvariant().Replace(" ", string.Empty);
        return $"status-{key}";
    }
    var apiKey = GoogleOptions.Value.ApiKey;
    var mapPoints = Model.Snapshots
        .Where(x => x.Lat.HasValue && x.Lng.HasValue)
        .Select(x => new
        {
            placeId = x.PlaceId,
            displayName = x.DisplayName,
            logoUrl = x.LogoUrl,
            rating = x.Rating,
            userRatingCount = x.UserRatingCount,
            primaryCategory = x.PrimaryCategory,
            lat = x.Lat!.Value,
            lng = x.Lng!.Value,
            detailsUrl = $"/places/{x.PlaceId}?runId={Model.Run.SearchRunId}"
        })
        .ToList();
    var capturedStampUtc = Model.Snapshots.FirstOrDefault()?.CapturedAtUtc;
    var keyphraseTraffic = Model.KeyphraseTraffic;
}

<div class="page-stack">
    <div class="run-summary-grid">
        <section class="card">
            <h2 class="card-title">Run @Model.Run.SearchRunId</h2>
            <div><strong>Keyword:</strong> @Model.Run.SeedKeyword</div>
            <div><strong>Location:</strong> @Model.Run.LocationName</div>
            <div><strong>Search Depth:</strong> @Model.Run.ResultLimit</div>
            <div><strong>Get Enhanced Google Data:</strong> @(Model.Run.FetchDetailedData ? "Yes" : "No")</div>
            <div><strong>Get Google Reviews:</strong> @(Model.Run.FetchGoogleReviews ? "Yes" : "No")</div>
            <div><strong>Get Google Updates:</strong> @(Model.Run.FetchGoogleUpdates ? "Yes" : "No")</div>
            <div><strong>Get Google Question &amp; Answers:</strong> @(Model.Run.FetchGoogleQuestionsAndAnswers ? "Yes" : "No")</div>
            <div><strong>Get Google Social Profiles:</strong> @(Model.Run.FetchGoogleSocialProfiles ? "Yes" : "No")</div>
            <div><strong>Captured:</strong> @(capturedStampUtc?.ToString("u") ?? "N/A")</div>
        </section>
        <section class="run-actions-grid">
            <a href="/runs/@Model.Run.SearchRunId/compare-reviews" class="home-nav-card run-action-card">
                <i class="bi bi-bar-chart-line home-nav-icon"></i>
                <span class="home-nav-title">Compare Reviews</span>
                <span class="home-nav-subtitle">Compare review velocity and trends for this run</span>
            </a>
            <a href="/search?rerunId=@Model.Run.SearchRunId" class="home-nav-card run-action-card">
                <i class="bi bi-arrow-repeat home-nav-icon"></i>
                <span class="home-nav-title">Rerun</span>
                <span class="home-nav-subtitle">Run this search again with the same inputs</span>
            </a>
        </section>
    </div>

    @if (Model.TaskProgress.Count > 0)
    {
        <section class="card">
            <h2 class="card-title">Data Task Progress</h2>
            <div class="stats-grid">
                @foreach (var p in Model.TaskProgress)
                {
                    var hasErrors = p.ErrorCount > 0;
                    var isComplete = p.DueCount > 0 && p.CompletedCount >= p.DueCount && !hasErrors;
                    var isNotDue = p.DueCount == 0;
                    var stateClass = hasErrors ? "status-error"
                        : isComplete ? "status-healthy"
                        : isNotDue ? "status-nodata"
                        : "status-pending";
                    var headline = hasErrors
                        ? $"{p.Label} Errors {p.ErrorCount}"
                        : isComplete
                            ? $"{p.Label} Complete"
                            : isNotDue
                                ? $"{p.Label} Not Due"
                                : $"{p.Label} Processing {p.ProcessingCount} of {p.TotalPlaces}";
                    <div class="stat-card">
                        <span class="stat-label">@p.Label</span>
                        <div class="toolbar">
                            <span class="status-pill @stateClass">@headline</span>
                        </div>
                        <div class="muted">Finished: @p.CompletedCount of @p.DueCount</div>
                        @if (p.ErrorCount > 0)
                        {
                            <div class="muted">Errors: @p.ErrorCount</div>
                        }
                    </div>
                }
            </div>
        </section>
    }

    <section class="card">
        <h2 class="card-title">Snapshots</h2>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th class="run-logo-col" aria-label="Logo"></th>
                        <th>Name</th>
                        <th title="Financial Information"><i class="bi bi-bank2" aria-hidden="true"></i></th>
                        <th title="Zoho Connected"><i class="bi bi-person-vcard-fill" aria-hidden="true"></i></th>
                        <th>Primary Category</th>
                        <th>Avg Clicks</th>
                        <th>Avg Rating</th>
                        <th>Total Reviews</th>
                        <th>Days last review</th>
                        <th>Review Status</th>
                        <th>Number of Updates</th>
                        <th>Days last update</th>
                        <th>Update Status</th>
                        <th>Website</th>
                        <th>Description</th>
                        <th>Other Categories</th>
                        <th>Photos</th>
                        <th>Number of Q&amp;As</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var s in Model.Snapshots)
                {
                    var websiteYes = !string.IsNullOrWhiteSpace(s.WebsiteUri);
                    var hasOtherCategories = s.HasOtherCategories ?? false;
                    var hasLogo = !string.IsNullOrWhiteSpace(s.LogoUrl);
                    var descriptionLength = Math.Max(0, s.DescriptionLength ?? 0);
                    var descriptionPercent = Math.Clamp((int)Math.Round((descriptionLength / 750.0) * 100.0), 0, 100);
                    var descriptionStatusClass = descriptionPercent < 33
                        ? "status-error"
                        : descriptionPercent < 66
                            ? "status-pending"
                            : "status-healthy";
                    <tr>
                        <td>@s.RankPosition</td>
                        <td class="run-logo-cell">
                            @if (hasLogo)
                            {
                                <img class="run-place-logo" src="@s.LogoUrl" alt="@(s.DisplayName ?? "Place") logo" loading="lazy" onerror="this.style.display='none';" />
                            }
                        </td>
                        <td><a href="/places/@s.PlaceId?runId=@Model.Run.SearchRunId">@(s.DisplayName ?? "N/A")</a></td>
                        <td class="run-indicator-cell">
                            <span class="run-indicator @(s.HasFinancialInfo ? "is-yes" : "is-no")" title="@(s.HasFinancialInfo ? "Financial information available" : "No financial information")">
                                <i class="bi bi-bank2" aria-hidden="true"></i>
                            </span>
                        </td>
                        <td class="run-indicator-cell">
                            <span class="run-indicator @(s.IsZohoConnected ? "is-yes" : "is-no")" title="@(s.IsZohoConnected ? "Connected to Zoho" : "Not connected to Zoho")">
                                <i class="bi bi-person-vcard-fill" aria-hidden="true"></i>
                            </span>
                        </td>
                        <td>@(string.IsNullOrWhiteSpace(s.PrimaryCategory) ? "N/A" : s.PrimaryCategory)</td>
                        <td>@(s.AvgClicks?.ToString("N0") ?? "0")</td>
                        <td>
                            @if (s.Rating.HasValue)
                            {
                                var clampedRating = Math.Clamp((double)s.Rating.Value, 0d, 5d);
                                var roundedHalfStars = Math.Clamp((int)Math.Round(clampedRating * 2d, MidpointRounding.AwayFromZero), 0, 10);
                                var fullStars = roundedHalfStars / 2;
                                var hasHalfStar = roundedHalfStars % 2 == 1;
                                var emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
                                <span class="run-rating-stars" title="@($"{clampedRating:0.0} out of 5")" aria-label="@($"{clampedRating:0.0} out of 5 stars")">
                                    @for (var i = 0; i < fullStars; i++)
                                    {
                                        <i class="bi bi-star-fill" aria-hidden="true"></i>
                                    }
                                    @if (hasHalfStar)
                                    {
                                        <i class="bi bi-star-half" aria-hidden="true"></i>
                                    }
                                    @for (var i = 0; i < emptyStars; i++)
                                    {
                                        <i class="bi bi-star" aria-hidden="true"></i>
                                    }
                                </span>
                            }
                        </td>
                        <td>@(s.UserRatingCount?.ToString() ?? "N/A")</td>
                        <td>@(s.DaysSinceLastReview?.ToString() ?? "N/A")</td>
                        <td><span class="status-pill @StatusCss(s.StatusLabel, "noreviews")">@(s.StatusLabel ?? "NoReviews")</span></td>
                        <td>@(s.UpdateCount?.ToString() ?? "0")</td>
                        <td>@(s.DaysSinceLastUpdate?.ToString() ?? "N/A")</td>
                        <td><span class="status-pill @StatusCss(s.UpdateStatusLabel, "noupdates")">@(s.UpdateStatusLabel ?? "NoUpdates")</span></td>
                        <td><span class="status-pill @(websiteYes ? "status-healthy" : "status-nodata")">@(websiteYes ? "Yes" : "No")</span></td>
                        <td><span class="status-pill @descriptionStatusClass">@descriptionPercent%</span></td>
                        <td><span class="status-pill @(hasOtherCategories ? "status-healthy" : "status-nodata")">@(hasOtherCategories ? "Yes" : "No")</span></td>
                        <td>@(s.PhotoCount?.ToString() ?? "N/A")</td>
                        <td>@(s.QuestionAnswerCount?.ToString() ?? "0")</td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </section>

    <section class="card">
        <div class="card-header">
            <h2 class="card-title">Total Search Volume (Keyphrases)</h2>
            @if (keyphraseTraffic is not null)
            {
                <a class="btn btn-secondary" href="@keyphraseTraffic.KeyphrasesUrl">View Keyphrase Breakdown</a>
            }
        </div>
        @if (keyphraseTraffic is null)
        {
            <p class="muted">No keyphrases are associated with this run's location/category yet.</p>
        }
        else if (keyphraseTraffic.Last12Months.Count == 0)
        {
            <p class="muted">Keyphrases exist, but there is no monthly search volume data yet.</p>
        }
        else
        {
            var maxTotal = keyphraseTraffic.Last12Months.Max(x => x.WeightedSearchVolume);
            <div class="volume-chart">
                @foreach (var point in keyphraseTraffic.Last12Months)
                {
                    var heightPercent = maxTotal <= 0 ? 0 : Math.Max(5, (int)Math.Round((point.WeightedSearchVolume * 100m) / maxTotal));
                    <div class="volume-chart-column">
                        <div class="volume-chart-plot">
                            <span class="volume-chart-bar" style="height:@heightPercent%" title="@point.Year-@point.Month.ToString("00"): @point.WeightedSearchVolume.ToString("N1")"></span>
                        </div>
                        <span class="volume-chart-label">@point.Year-@point.Month.ToString("00")</span>
                        <span class="volume-chart-value">@point.WeightedSearchVolume.ToString("N0")</span>
                    </div>
                }
            </div>
            <p class="muted">
                Weighted Avg: @keyphraseTraffic.WeightedAvgSearchVolume.ToString("N0")
                @if (keyphraseTraffic.WeightedLastMonthSearchVolume.HasValue && keyphraseTraffic.LatestMonthYear.HasValue && keyphraseTraffic.LatestMonthNumber.HasValue)
                {
                    <text> | Last Month (@keyphraseTraffic.LatestMonthYear-@keyphraseTraffic.LatestMonthNumber.Value.ToString("00")): @keyphraseTraffic.WeightedLastMonthSearchVolume.Value.ToString("N0")</text>
                }
            </p>
        }
        <p class="muted">Main term is counted at 100%. Modifier and Adjacent are counted at 70%. Synonyms and no-data rows are excluded.</p>
    </section>

    <section class="card">
        <h2 class="card-title">Search Center Map</h2>
        @if (string.IsNullOrWhiteSpace(apiKey))
        {
            <p class="muted">Map unavailable because Google API key is not configured.</p>
        }
        else
        {
            <div class="map-shell">
                <div id="run-map" class="map-large"></div>
                <aside id="run-map-overlap-panel" class="map-overlap-panel is-hidden" aria-label="Businesses at this location">
                    <div class="map-overlap-header">
                        <h3 id="run-map-overlap-title">Businesses at this location</h3>
                        <button type="button" id="run-map-overlap-close" class="btn btn-secondary">Close</button>
                    </div>
                    <div id="run-map-overlap-list" class="map-overlap-list"></div>
                </aside>
            </div>
            <p class="muted">Blue marker = search center. Red markers = businesses.</p>
            <script>
                const runCenter = {
                    lat: @((Model.Run.CenterLat?.ToString(System.Globalization.CultureInfo.InvariantCulture)) ?? "null"),
                    lng: @((Model.Run.CenterLng?.ToString(System.Globalization.CultureInfo.InvariantCulture)) ?? "null")
                };
                const businessPins = @Html.Raw(JsonSerializer.Serialize(mapPoints));
                const OVERLAP_THRESHOLD_METERS = 2;

                function escapeHtml(value) {
                    if (value === null || value === undefined) return "";
                    return String(value)
                        .replaceAll("&", "&amp;")
                        .replaceAll("<", "&lt;")
                        .replaceAll(">", "&gt;")
                        .replaceAll("\"", "&quot;")
                        .replaceAll("'", "&#39;");
                }

                function distanceMeters(aLat, aLng, bLat, bLng) {
                    const toRad = Math.PI / 180;
                    const dLat = (bLat - aLat) * toRad;
                    const dLng = (bLng - aLng) * toRad;
                    const lat1 = aLat * toRad;
                    const lat2 = bLat * toRad;
                    const sinDLat = Math.sin(dLat / 2);
                    const sinDLng = Math.sin(dLng / 2);
                    const h = (sinDLat * sinDLat) + (Math.cos(lat1) * Math.cos(lat2) * sinDLng * sinDLng);
                    return 6371000 * (2 * Math.atan2(Math.sqrt(h), Math.sqrt(1 - h)));
                }

                function buildBuckets(pins, thresholdMeters) {
                    const buckets = [];
                    const pinBucketIds = new Array(pins.length).fill(-1);

                    for (let i = 0; i < pins.length; i++) {
                        const pin = pins[i];
                        let foundBucket = null;
                        for (const bucket of buckets) {
                            if (distanceMeters(pin.lat, pin.lng, bucket.anchor.lat, bucket.anchor.lng) <= thresholdMeters) {
                                foundBucket = bucket;
                                break;
                            }
                        }

                        if (!foundBucket) {
                            foundBucket = {
                                id: buckets.length,
                                anchor: { lat: pin.lat, lng: pin.lng },
                                pinIndexes: []
                            };
                            buckets.push(foundBucket);
                        }

                        foundBucket.pinIndexes.push(i);
                        pinBucketIds[i] = foundBucket.id;
                    }

                    return { buckets, pinBucketIds };
                }

                function createDotIcon(fillColor, strokeColor, scale, strokeWeight) {
                    return {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale,
                        fillColor,
                        fillOpacity: 1,
                        strokeColor,
                        strokeWeight
                    };
                }

                function buildSpiderOffsets(count) {
                    const offsets = [];
                    if (count <= 8) {
                        const radius = 42;
                        for (let i = 0; i < count; i++) {
                            const angle = (2 * Math.PI * i) / count;
                            offsets.push({
                                x: radius * Math.cos(angle),
                                y: radius * Math.sin(angle)
                            });
                        }
                        return offsets;
                    }

                    let angle = 0;
                    let radius = 24;
                    for (let i = 0; i < count; i++) {
                        angle += 0.72;
                        radius += 4.4;
                        offsets.push({
                            x: radius * Math.cos(angle),
                            y: radius * Math.sin(angle)
                        });
                    }
                    return offsets;
                }

                function parseRating(value) {
                    const numeric = Number(value);
                    if (!Number.isFinite(numeric)) return null;
                    if (numeric < 0) return 0;
                    if (numeric > 5) return 5;
                    return numeric;
                }

                function buildRatingStarsHtml(value) {
                    const rating = parseRating(value);
                    if (rating === null) {
                        return `<span class="rating-stars"><i class="bi bi-star" aria-hidden="true"></i><i class="bi bi-star" aria-hidden="true"></i><i class="bi bi-star" aria-hidden="true"></i><i class="bi bi-star" aria-hidden="true"></i><i class="bi bi-star" aria-hidden="true"></i></span>`;
                    }

                    const roundedHalfStars = Math.min(10, Math.max(0, Math.round(rating * 2)));
                    const fullStars = Math.floor(roundedHalfStars / 2);
                    const hasHalfStar = roundedHalfStars % 2 === 1;
                    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
                    let html = `<span class="rating-stars" title="${rating.toFixed(1)} out of 5">`;
                    for (let i = 0; i < fullStars; i++) html += `<i class="bi bi-star-fill" aria-hidden="true"></i>`;
                    if (hasHalfStar) html += `<i class="bi bi-star-half" aria-hidden="true"></i>`;
                    for (let i = 0; i < emptyStars; i++) html += `<i class="bi bi-star" aria-hidden="true"></i>`;
                    html += `</span>`;
                    return html;
                }

                function initRunMap() {
                    const hasCenter = runCenter.lat !== null && runCenter.lng !== null;
                    const map = new google.maps.Map(document.getElementById("run-map"), {
                        center: hasCenter ? { lat: runCenter.lat, lng: runCenter.lng } : { lat: 0, lng: 0 },
                        zoom: 12
                    });
                    const bounds = new google.maps.LatLngBounds();
                    const infoWindow = new google.maps.InfoWindow();
                    const overlapPanel = document.getElementById("run-map-overlap-panel");
                    const overlapTitle = document.getElementById("run-map-overlap-title");
                    const overlapList = document.getElementById("run-map-overlap-list");
                    const overlapCloseButton = document.getElementById("run-map-overlap-close");

                    const overlay = new google.maps.OverlayView();
                    overlay.onAdd = function () { };
                    overlay.draw = function () { };
                    overlay.onRemove = function () { };
                    overlay.setMap(map);

                    const { buckets, pinBucketIds } = buildBuckets(businessPins, OVERLAP_THRESHOLD_METERS);
                    const markerRecords = [];
                    const recordsByBucket = new Map();
                    let activeSpider = null;
                    let activeBucketId = null;
                    let activeRecordId = null;

                    function setRecordHighlight(record, isHighlighted) {
                        record.marker.setIcon(isHighlighted ? record.highlightIcon : record.defaultIcon);
                    }

                    function clearRecordHighlights() {
                        for (const record of markerRecords) {
                            setRecordHighlight(record, false);
                        }
                    }

                    function setActiveListItem(recordId) {
                        activeRecordId = recordId;
                        if (!(overlapList instanceof HTMLElement)) return;
                        for (const item of overlapList.querySelectorAll(".map-overlap-item")) {
                            item.classList.toggle("is-active", item.dataset.recordId === String(recordId));
                        }
                    }

                    function getInfoHtml(pin) {
                        const logoHtml = pin.logoUrl
                            ? `<img class="map-info-logo" src="${escapeHtml(pin.logoUrl)}" alt="" loading="lazy" onerror="this.remove();" />`
                            : "";
                        const ratingCount = pin.userRatingCount === null || pin.userRatingCount === undefined
                            ? "N/A"
                            : String(pin.userRatingCount);
                        return `
                            <div class="map-info">
                                ${logoHtml}
                                <div class="map-info-title">${escapeHtml(pin.displayName || "N/A")}</div>
                                <div class="map-info-rating">
                                    ${buildRatingStarsHtml(pin.rating)}
                                    <span class="map-rating-count">(${escapeHtml(ratingCount)})</span>
                                </div>
                                <div class="map-info-subtitle">${escapeHtml(pin.primaryCategory || "N/A")}</div>
                                <div class="map-info-link"><a href="${escapeHtml(pin.detailsUrl)}">View</a></div>
                            </div>`;
                    }

                    function closeOverlap() {
                        if (activeSpider) {
                            for (const leg of activeSpider.legs) {
                                leg.setMap(null);
                            }
                            for (const record of activeSpider.records) {
                                record.marker.setPosition(record.originalPosition);
                                record.marker.setZIndex(undefined);
                            }
                        }
                        activeSpider = null;
                        activeBucketId = null;
                        activeRecordId = null;
                        clearRecordHighlights();
                        if (overlapPanel instanceof HTMLElement) {
                            overlapPanel.classList.add("is-hidden");
                        }
                        if (overlapList instanceof HTMLElement) {
                            overlapList.innerHTML = "";
                        }
                    }

                    function openInfo(record) {
                        infoWindow.setContent(getInfoHtml(record.pin));
                        infoWindow.open({ map, anchor: record.marker });
                        clearRecordHighlights();
                        setRecordHighlight(record, true);
                        setActiveListItem(record.id);
                    }

                    function offsetLatLng(centerLatLng, xPixels, yPixels) {
                        const projection = overlay.getProjection();
                        if (projection) {
                            const centerPoint = projection.fromLatLngToDivPixel(centerLatLng);
                            if (centerPoint) {
                                const targetPoint = new google.maps.Point(centerPoint.x + xPixels, centerPoint.y + yPixels);
                                const latLng = projection.fromDivPixelToLatLng(targetPoint);
                                if (latLng) {
                                    return latLng;
                                }
                            }
                        }

                        const metersPerPixel = (156543.03392 * Math.cos(centerLatLng.lat() * Math.PI / 180)) / Math.pow(2, map.getZoom());
                        const distance = Math.sqrt((xPixels * xPixels) + (yPixels * yPixels)) * metersPerPixel;
                        const angleRad = Math.atan2(yPixels, xPixels);
                        const heading = (angleRad * 180 / Math.PI + 360) % 360;
                        return google.maps.geometry.spherical.computeOffset(centerLatLng, distance, heading);
                    }

                    function renderOverlapPanel(bucketId) {
                        if (!(overlapPanel instanceof HTMLElement) || !(overlapTitle instanceof HTMLElement) || !(overlapList instanceof HTMLElement)) {
                            return;
                        }

                        const records = recordsByBucket.get(bucketId) ?? [];
                        overlapTitle.textContent = `Businesses at this location (${records.length})`;
                        overlapList.innerHTML = "";

                        records.forEach((record) => {
                            const item = document.createElement("button");
                            item.type = "button";
                            item.className = "map-overlap-item";
                            item.dataset.recordId = String(record.id);
                            const logoHtml = record.pin.logoUrl
                                ? `<img class="map-overlap-item-logo" src="${escapeHtml(record.pin.logoUrl)}" alt="" loading="lazy" onerror="this.remove();" />`
                                : "";
                            const ratingCount = record.pin.userRatingCount === null || record.pin.userRatingCount === undefined
                                ? "N/A"
                                : String(record.pin.userRatingCount);
                            item.innerHTML = `
                                <div class="map-overlap-item-head">
                                    ${logoHtml}
                                    <div class="map-overlap-item-name">${escapeHtml(record.pin.displayName || "N/A")}</div>
                                </div>
                                <div class="map-overlap-item-rating">
                                    ${buildRatingStarsHtml(record.pin.rating)}
                                    <span class="map-rating-count">(${escapeHtml(ratingCount)})</span>
                                </div>
                                <div class="map-overlap-item-meta">${escapeHtml(record.pin.primaryCategory || "N/A")}</div>
                            `;

                            item.addEventListener("mouseenter", () => {
                                clearRecordHighlights();
                                setRecordHighlight(record, true);
                            });
                            item.addEventListener("mouseleave", () => {
                                clearRecordHighlights();
                                const active = markerRecords.find(x => x.id === activeRecordId);
                                if (active) {
                                    setRecordHighlight(active, true);
                                }
                            });
                            item.addEventListener("click", () => {
                                openInfo(record);
                            });

                            overlapList.appendChild(item);
                        });

                        overlapPanel.classList.remove("is-hidden");
                    }

                    function spiderfyBucket(bucketId) {
                        closeOverlap();

                        const records = recordsByBucket.get(bucketId) ?? [];
                        if (records.length <= 1) {
                            return;
                        }

                        const bucket = buckets.find(b => b.id === bucketId);
                        if (!bucket) {
                            return;
                        }

                        const center = new google.maps.LatLng(bucket.anchor.lat, bucket.anchor.lng);
                        const offsets = buildSpiderOffsets(records.length);
                        const legs = [];

                        records.forEach((record, idx) => {
                            const offset = offsets[idx];
                            const targetLatLng = offsetLatLng(center, offset.x, offset.y);
                            record.marker.setPosition(targetLatLng);
                            record.marker.setZIndex(10000 + idx);

                            legs.push(new google.maps.Polyline({
                                map,
                                path: [center, targetLatLng],
                                strokeColor: "#64748b",
                                strokeOpacity: 0.85,
                                strokeWeight: 1.4,
                                clickable: false
                            }));
                        });

                        activeBucketId = bucketId;
                        activeSpider = { bucketId, records, legs };
                        renderOverlapPanel(bucketId);
                    }

                    if (hasCenter) {
                        const centerPosition = { lat: runCenter.lat, lng: runCenter.lng };
                        new google.maps.Marker({
                            map,
                            position: centerPosition,
                            title: "Search Center",
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 11,
                                fillColor: "#1a73e8",
                                fillOpacity: 1,
                                strokeColor: "#0b3d91",
                                strokeWeight: 2
                            }
                        });
                        bounds.extend(centerPosition);
                    }

                    businessPins.forEach((pin, index) => {
                        const position = { lat: pin.lat, lng: pin.lng };
                        const defaultIcon = createDotIcon("#e53935", "#7f0000", 11, 2);
                        const highlightIcon = createDotIcon("#e53935", "#1e3a8a", 14, 3);
                        const marker = new google.maps.Marker({
                            map,
                            position,
                            title: pin.displayName || "Business",
                            icon: defaultIcon
                        });

                        const record = {
                            id: index,
                            pin,
                            marker,
                            bucketId: pinBucketIds[index],
                            originalPosition: new google.maps.LatLng(position.lat, position.lng),
                            defaultIcon,
                            highlightIcon
                        };
                        markerRecords.push(record);

                        if (!recordsByBucket.has(record.bucketId)) {
                            recordsByBucket.set(record.bucketId, []);
                        }
                        recordsByBucket.get(record.bucketId).push(record);

                        marker.addListener("click", () => {
                            const bucketRecords = recordsByBucket.get(record.bucketId) ?? [];
                            if (bucketRecords.length <= 1) {
                                closeOverlap();
                                openInfo(record);
                                return;
                            }

                            if (activeBucketId !== record.bucketId) {
                                spiderfyBucket(record.bucketId);
                            }

                            openInfo(record);
                        });

                        bounds.extend(position);
                    });

                    if (overlapCloseButton instanceof HTMLButtonElement) {
                        overlapCloseButton.addEventListener("click", () => {
                            closeOverlap();
                            infoWindow.close();
                        });
                    }

                    map.addListener("click", () => {
                        closeOverlap();
                    });
                    map.addListener("dragstart", () => {
                        closeOverlap();
                    });
                    map.addListener("zoom_changed", () => {
                        closeOverlap();
                    });
                    document.addEventListener("keydown", (event) => {
                        if (event.key === "Escape") {
                            closeOverlap();
                            infoWindow.close();
                        }
                    });

                    if (!bounds.isEmpty()) {
                        map.fitBounds(bounds);
                    }
                }
            </script>
            <script async defer src="https://maps.googleapis.com/maps/api/js?key=@System.Uri.EscapeDataString(apiKey)&libraries=geometry&callback=initRunMap"></script>
        }
    </section>
</div>

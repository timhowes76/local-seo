@inject LocalSeo.Web.Services.IUserRepository UserRepository
@inject LocalSeo.Web.Services.IAvatarResolver AvatarResolver
@{
    var isAuthenticated = User.Identity?.IsAuthenticated == true;
    var isAdmin = User.HasClaim(LocalSeo.Web.Services.AuthClaimTypes.IsAdmin, "true");
    var pageTitle = (ViewData["Title"] as string) ?? (ViewContext.RouteData.Values["controller"]?.ToString() ?? "Dashboard");
    var currentController = (ViewContext.RouteData.Values["controller"]?.ToString() ?? string.Empty).ToLowerInvariant();
    var isDarkMode = false;
    var brandLogoPath = "/assets/images/logo.svg";
    LocalSeo.Web.Models.UserRecord? topbarUser = null;
    var topbarDisplayName = User.Identity?.Name ?? "User";
    var topbarAvatar = AvatarResolver.Resolve(null, 40);

    if (isAuthenticated)
    {
        if (Context.Items.TryGetValue("CurrentUserRecord", out var currentUserObject)
            && currentUserObject is LocalSeo.Web.Models.UserRecord resolvedUser)
        {
            topbarUser = resolvedUser;
            isDarkMode = resolvedUser.IsDarkMode;
        }
        else
        {
            var userIdRaw = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (int.TryParse(userIdRaw, out var userId) && userId > 0)
            {
                try
                {
                    topbarUser = await UserRepository.GetByIdAsync(userId, Context.RequestAborted);
                }
                catch
                {
                    // Keep rendering even if user lookup fails.
                }
            }
        }

        if (topbarUser is not null)
        {
            topbarDisplayName = $"{topbarUser.FirstName} {topbarUser.LastName}".Trim();
            topbarAvatar = AvatarResolver.Resolve(topbarUser, 40);
        }
    }
    else
    {
        isDarkMode = string.Equals(Context.Request.Cookies["theme"], "dark=1", StringComparison.Ordinal);
    }

    if (isDarkMode)
        brandLogoPath = "/assets/images/dark-logo.svg";

    var breadcrumbMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
    {
        ["admin"] = "Admin",
        ["data-lists"] = "Data Lists",
        ["counties-gb"] = "Counties (GB)",
        ["towns-gb"] = "Towns (GB)",
        ["google-business-profile-categories"] = "Google Business Profile Categories",
        ["search"] = "Search",
        ["runs"] = "Runs",
        ["places"] = "Places",
        ["profile"] = "Profile",
        ["edit"] = "Edit",
        ["change-password"] = "Change Password",
        ["settings"] = "Settings",
        ["logs"] = "Logs",
        ["login-log"] = "Login Log",
        ["emails"] = "Emails",
        ["email-templates"] = "Email Templates",
        ["site"] = "Site",
        ["data-collection-windows"] = "Data Collection Windows",
        ["map-pack-ctr-model"] = "Map Pack CTR Model",
        ["zoho-lead-defaults"] = "Zoho Lead Defaults",
        ["security"] = "Security",
        ["location"] = "Location",
        ["category"] = "Category",
        ["keyphrases"] = "Keyphrases",
        ["categories"] = "Categories"
    };
    var breadcrumbs = new List<(string Label, string Url, bool IsCurrent)>();
    var path = (Context.Request.Path.Value ?? "/").TrimEnd('/');
    if (isAuthenticated)
    {
        breadcrumbs.Add(("Home", "/", path == string.Empty || path == "/"));
        var pathSegments = path.Split('/', StringSplitOptions.RemoveEmptyEntries);
        if (pathSegments.Length > 0)
        {
            var cumulative = string.Empty;
            for (var i = 0; i < pathSegments.Length; i++)
            {
                var segment = pathSegments[i];
                cumulative += "/" + segment;
                var isCurrent = i == pathSegments.Length - 1;
                var label = breadcrumbMap.TryGetValue(segment, out var mappedLabel)
                    ? mappedLabel
                    : segment;
                if (!breadcrumbMap.ContainsKey(segment))
                {
                    if (long.TryParse(segment, out var idValue))
                        label = $"#{idValue}";
                    else if (segment.Length > 24 && segment.All(ch => char.IsLetterOrDigit(ch) || ch is '-' or '_'))
                        label = "Item";
                    else
                        label = string.Join(' ', segment.Split(new[] { '-', '_' }, StringSplitOptions.RemoveEmptyEntries)
                            .Select(part => part.Length == 0 ? part : char.ToUpperInvariant(part[0]) + part[1..].ToLowerInvariant()));
                }
                breadcrumbs.Add((label, cumulative, isCurrent));
            }
        }
    }
}
<!DOCTYPE html>
<html class="@(isDarkMode ? "theme-dark" : null)">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@(ViewData["Title"] as string ?? "Local SEO Tool")</title>
    <link rel="icon" type="image/png" href="/assets/images/favicon.png" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="/css/site.css" />
</head>
<body>

@if (isAuthenticated)
{
    <div class="dashboard-shell">
        <aside class="sidebar">
            <div class="sidebar-brand">
                <img class="sidebar-brand-logo" src="@brandLogoPath" alt="Kontrolit" />
                <div class="sidebar-brand-title">Local SEO Tool</div>
            </div>
            <nav class="sidebar-nav">
                <a class="sidebar-link @(currentController == "home" ? "is-active" : null)" href="/">
                    <i class="bi bi-house-door"></i>
                    <span>Home</span>
                </a>
                <a class="sidebar-link @(currentController == "search" ? "is-active" : null)" href="/search">
                    <i class="bi bi-search"></i>
                    <span>Search</span>
                </a>
                <a class="sidebar-link @(currentController == "runs" ? "is-active" : null)" href="/runs">
                    <i class="bi bi-list-check"></i>
                    <span>Runs</span>
                </a>
                <a class="sidebar-link @(currentController == "places" ? "is-active" : null)" href="/places">
                    <i class="bi bi-geo-alt"></i>
                    <span>Places</span>
                </a>
                @if (isAdmin)
                {
                    <a class="sidebar-link @(currentController == "admin" ? "is-active" : null)" href="/admin">
                        <i class="bi bi-gear"></i>
                        <span>Admin</span>
                    </a>
                }
            </nav>
        </aside>

        <div class="main-shell">
            <header class="topbar">
                <div class="topbar-main">
                    <h1 class="topbar-title">@pageTitle</h1>
                    <div class="topbar-actions">
                        <details class="avatar-menu">
                            <summary class="avatar-menu-toggle" aria-label="Open user menu">
                                @if (!string.IsNullOrWhiteSpace(topbarAvatar.ImageUrl))
                                {
                                    <img class="avatar-image" src="@topbarAvatar.ImageUrl" alt="@topbarDisplayName" />
                                }
                                else
                                {
                                    <span class="avatar-initials">@topbarAvatar.Initials</span>
                                }
                            </summary>
                            <div class="avatar-menu-panel">
                                <div class="avatar-menu-heading">
                                    <strong>@topbarDisplayName</strong>
                                    <span>@(topbarUser?.EmailAddress ?? string.Empty)</span>
                                </div>
                                <a class="avatar-menu-item" href="/profile/edit">
                                    <i class="bi bi-person"></i>
                                    <span>Edit profile</span>
                                </a>
                                <a class="avatar-menu-item" href="/profile/change-password">
                                    <i class="bi bi-shield-lock"></i>
                                    <span>Change password</span>
                                </a>
                                <div class="avatar-menu-divider"></div>
                                <form method="post" action="/logout" class="avatar-menu-form">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="avatar-menu-item avatar-menu-button">
                                        <i class="bi bi-box-arrow-right"></i>
                                        <span>Log out</span>
                                    </button>
                                </form>
                            </div>
                        </details>
                    </div>
                </div>
                @if (breadcrumbs.Count > 1)
                {
                    <nav class="breadcrumbs" aria-label="Breadcrumb">
                        <ol>
                            @for (var i = 0; i < breadcrumbs.Count; i++)
                            {
                                var crumb = breadcrumbs[i];
                                <li>
                                    @if (crumb.IsCurrent)
                                    {
                                        <span aria-current="page">@crumb.Label</span>
                                    }
                                    else
                                    {
                                        <a href="@crumb.Url">@crumb.Label</a>
                                    }
                                    @if (i < breadcrumbs.Count - 1)
                                    {
                                        <span class="breadcrumbs-separator">/</span>
                                    }
                                </li>
                            }
                        </ol>
                    </nav>
                }
            </header>
            <main class="content-shell">
                @RenderBody()
            </main>
        </div>
    </div>
}
else
{
    <main class="auth-shell">
        @RenderBody()
    </main>
}
<script src="~/js/password-toggle.js" asp-append-version="true"></script>
</body>
</html>

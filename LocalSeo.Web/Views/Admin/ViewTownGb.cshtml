@inject Microsoft.Extensions.Options.IOptions<LocalSeo.Web.Options.GoogleOptions> GoogleOptions
@model GbTownDetailsViewModel
@{
    ViewData["Title"] = "View Town (GB)";
    var town = Model.Town;
    var returnQ = (ViewBag.ReturnQ as string ?? string.Empty).Trim();
    var returnStatus = (ViewBag.ReturnStatus as string ?? "active").Trim().ToLowerInvariant();
    var returnCountyId = ViewBag.ReturnCountyId is long countyIdValue && countyIdValue > 0
        ? countyIdValue
        : (long?)null;
    var returnPage = ViewBag.ReturnPage is int p ? Math.Max(1, p) : 1;
    var returnPageSize = ViewBag.ReturnPageSize is int ps ? Math.Clamp(ps, 10, 200) : 50;

    var statusQuery = Uri.EscapeDataString(returnStatus);
    var searchQuery = string.IsNullOrWhiteSpace(returnQ) ? string.Empty : $"&q={Uri.EscapeDataString(returnQ)}";
    var countyQuery = returnCountyId.HasValue ? $"&countyId={returnCountyId.Value}" : string.Empty;
    var backUrl = $"/admin/data-lists/towns-gb?status={statusQuery}{searchQuery}{countyQuery}&page={returnPage}&pageSize={returnPageSize}";
    var editUrl = $"/admin/data-lists/towns-gb/edit?townId={town.TownId}&status={statusQuery}{searchQuery}{countyQuery}&page={returnPage}&pageSize={returnPageSize}";
    var statusText = town.IsActive ? "Active" : "Inactive";
    var apiKey = GoogleOptions.Value.ApiKey;
}

<div class="page-stack">
    <section class="card">
        <div class="toolbar">
            <a href="@backUrl" class="btn btn-secondary">Back to Towns</a>
            <a href="/admin/location/@town.TownId/categories" class="btn btn-secondary">Category Keyphrases</a>
            <a href="@editUrl" class="btn btn-secondary">Edit</a>
        </div>
    </section>

    <section class="card">
        <h2 class="card-title">Town Details - @town.Name (@statusText)</h2>
    </section>

    <section class="card">
        <h2 class="card-title">Town Location Map</h2>
        @if (string.IsNullOrWhiteSpace(apiKey))
        {
            <p class="muted">Map unavailable because Google API key is not configured.</p>
        }
        else if (!town.Latitude.HasValue || !town.Longitude.HasValue)
        {
            <p class="muted">No coordinates stored yet for this town.</p>
        }
        else
        {
            <div id="town-map" class="map-medium"></div>
            <script>
                const townLocation = {
                    lat: @town.Latitude.Value.ToString(System.Globalization.CultureInfo.InvariantCulture),
                    lng: @town.Longitude.Value.ToString(System.Globalization.CultureInfo.InvariantCulture)
                };

                function initTownMap() {
                    const map = new google.maps.Map(document.getElementById("town-map"), {
                        center: townLocation,
                        zoom: 13
                    });
                    new google.maps.Marker({
                        map,
                        position: townLocation,
                        title: "Town Location",
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 11,
                            fillColor: "#1a73e8",
                            fillOpacity: 1,
                            strokeColor: "#0b3d91",
                            strokeWeight: 2
                        }
                    });
                }
            </script>
            <script async defer src="https://maps.googleapis.com/maps/api/js?key=@System.Uri.EscapeDataString(apiKey)&callback=initTownMap"></script>
        }
    </section>

    <section class="card">
        <h2 class="card-title">Runs For This Town</h2>
        @if (Model.Runs.Count == 0)
        {
            <p class="muted">No runs found for this town.</p>
        }
        else
        {
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Keyword</th>
                            <th>Search Depth</th>
                            <th>Get Enahnced Google Data</th>
                            <th>Get Google Reviews</th>
                            <th>Get Google Updates</th>
                            <th>Get Google Question &amp; Answers</th>
                            <th>Get Google Social Profiles</th>
                            <th>Ran</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach (var r in Model.Runs)
                    {
                        <tr>
                            <td>@r.SearchRunId</td>
                            <td>@r.SeedKeyword</td>
                            <td>@r.ResultLimit</td>
                            <td><span class="status-pill @(r.FetchDetailedData ? "status-healthy" : "status-noreviews")">@(r.FetchDetailedData ? "Yes" : "No")</span></td>
                            <td><span class="status-pill @(r.FetchGoogleReviews ? "status-healthy" : "status-noreviews")">@(r.FetchGoogleReviews ? "Yes" : "No")</span></td>
                            <td><span class="status-pill @(r.FetchGoogleUpdates ? "status-healthy" : "status-noreviews")">@(r.FetchGoogleUpdates ? "Yes" : "No")</span></td>
                            <td><span class="status-pill @(r.FetchGoogleQuestionsAndAnswers ? "status-healthy" : "status-noreviews")">@(r.FetchGoogleQuestionsAndAnswers ? "Yes" : "No")</span></td>
                            <td><span class="status-pill @(r.FetchGoogleSocialProfiles ? "status-healthy" : "status-noreviews")">@(r.FetchGoogleSocialProfiles ? "Yes" : "No")</span></td>
                            <td>@r.RanAtUtc</td>
                            <td><a href="/runs/@r.SearchRunId">View</a></td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        }
    </section>
</div>

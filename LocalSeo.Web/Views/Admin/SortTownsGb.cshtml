@model GbTownSortViewModel
@{
    ViewData["Title"] = "Sort Towns (GB)";
    var statusMessage = TempData["Status"] as string;
    var selectedCountyId = Model.SelectedCountyId;
}

<div class="page-stack">
    @if (!string.IsNullOrWhiteSpace(statusMessage))
    {
        <div class="notice">@statusMessage</div>
    }

    <section class="card">
        <div class="toolbar">
            <a href="/admin/data-lists/towns-gb@(selectedCountyId.HasValue ? $"?countyId={selectedCountyId.Value}" : string.Empty)" class="btn btn-secondary">Back to Towns</a>
        </div>
    </section>

    <section class="card">
        <h2 class="card-title">Select County</h2>
        <form method="get" action="/admin/data-lists/towns-gb/sort" class="places-filter-line">
            <label for="countyId">County</label>
            <select id="countyId" name="countyId" class="js-searchable" data-placeholder="Search" required>
                <option value="">Select County</option>
                @foreach (var county in Model.CountyOptions)
                {
                    var label = county.IsActive ? county.Name : $"{county.Name} (Inactive)";
                    if (selectedCountyId.HasValue && selectedCountyId.Value == county.CountyId)
                    {
                        <option value="@county.CountyId" selected>@label</option>
                    }
                    else
                    {
                        <option value="@county.CountyId">@label</option>
                    }
                }
            </select>
            <button type="submit" class="btn btn-secondary">Load</button>
        </form>
    </section>

    <section class="card">
        <h2 class="card-title">Drag To Reorder Towns</h2>
        @if (!selectedCountyId.HasValue)
        {
            <p class="muted">Select a county first.</p>
        }
        else if (Model.Rows.Count == 0)
        {
            <p class="muted">No towns found for this county.</p>
        }
        else
        {
            <form method="post" action="/admin/data-lists/towns-gb/sort">
                @Html.AntiForgeryToken()
                <input type="hidden" name="countyId" value="@selectedCountyId.Value" />
                <input type="hidden" id="orderInput" name="order" value="" />
                <ul id="town-sort-list" class="sort-list">
                @foreach (var row in Model.Rows)
                {
                    <li class="sort-item" draggable="true" data-id="@row.TownId">
                        <span>@row.Name</span>
                        <span class="muted">@((row.IsActive ? "Active" : "Inactive"))</span>
                    </li>
                }
                </ul>
                <div class="toolbar">
                    <button type="submit">Save Order</button>
                </div>
            </form>
        }
    </section>
</div>

<script>
    (() => {
        const list = document.getElementById("town-sort-list");
        const orderInput = document.getElementById("orderInput");
        if (!(list instanceof HTMLElement) || !(orderInput instanceof HTMLInputElement)) return;

        let dragging = null;
        list.querySelectorAll(".sort-item").forEach((item) => {
            item.addEventListener("dragstart", () => {
                dragging = item;
                item.classList.add("is-dragging");
            });
            item.addEventListener("dragend", () => {
                item.classList.remove("is-dragging");
                dragging = null;
            });
            item.addEventListener("dragover", (e) => {
                e.preventDefault();
                if (!dragging || dragging === item) return;
                const rect = item.getBoundingClientRect();
                const shouldInsertBefore = e.clientY < rect.top + rect.height / 2;
                if (shouldInsertBefore) {
                    list.insertBefore(dragging, item);
                } else {
                    list.insertBefore(dragging, item.nextSibling);
                }
            });
        });

        list.closest("form")?.addEventListener("submit", () => {
            const ids = Array.from(list.querySelectorAll(".sort-item"))
                .map(x => x.getAttribute("data-id"))
                .filter(x => x);
            orderInput.value = ids.join(",");
        });
    })();
</script>


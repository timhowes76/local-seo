@model GbTownListViewModel
@{
    ViewData["Title"] = "Towns (GB)";
    var statusMessage = TempData["Status"] as string;
    var currentSearch = (Model.Search ?? string.Empty).Trim();
    var currentStatus = (Model.StatusFilter ?? "active").Trim().ToLowerInvariant();
    var selectedCountyId = Model.CountyIdFilter;
    var currentPage = Math.Max(1, Model.Page);
    var totalPages = Math.Max(1, Model.TotalPages);
    var hasPrev = currentPage > 1;
    var hasNext = currentPage < totalPages;

    var statusQuery = Uri.EscapeDataString(currentStatus);
    var pageSizeQuery = Model.PageSize.ToString();
    var searchQuery = string.IsNullOrWhiteSpace(currentSearch)
        ? string.Empty
        : $"&q={Uri.EscapeDataString(currentSearch)}";
    var countyQuery = selectedCountyId.HasValue
        ? $"&countyId={selectedCountyId.Value}"
        : string.Empty;

    string BuildListUrl(int page) =>
        $"/admin/data-lists/towns-gb?status={statusQuery}{searchQuery}{countyQuery}&page={page}&pageSize={pageSizeQuery}";

    string BuildActionQuery() =>
        $"status={statusQuery}{searchQuery}{countyQuery}&page={currentPage}&pageSize={pageSizeQuery}";
}

<div class="page-stack">
    @if (!string.IsNullOrWhiteSpace(statusMessage))
    {
        <div class="notice">@statusMessage</div>
    }

    <section class="card">
        <div class="toolbar">
            <a href="/admin/data-lists" class="btn btn-secondary">Back to Data Lists</a>
            <a href="/admin/data-lists/counties-gb" class="btn btn-secondary">Open Counties (GB)</a>
            <a href="/admin/data-lists/towns-gb/add?@BuildActionQuery()" class="btn btn-secondary">Add Town</a>
            <a href="/admin/data-lists/towns-gb/sort@(selectedCountyId.HasValue ? $"?countyId={selectedCountyId.Value}" : string.Empty)" class="btn btn-secondary">Sort Towns</a>
        </div>
    </section>

    <section class="card">
        <h2 class="card-title">Filters</h2>
        <form method="get" action="/admin/data-lists/towns-gb" class="places-filter-line">
            <label for="search">Text Search</label>
            <input id="search" name="q" type="text" value="@currentSearch" placeholder="Town Name, Slug, or External ID" />

            <label for="statusFilter">Status</label>
            <select id="statusFilter" name="status">
                @if (currentStatus == "active")
                {
                    <option value="active" selected>Active</option>
                }
                else
                {
                    <option value="active">Active</option>
                }
                @if (currentStatus == "inactive")
                {
                    <option value="inactive" selected>Inactive</option>
                }
                else
                {
                    <option value="inactive">Inactive</option>
                }
                @if (currentStatus == "all")
                {
                    <option value="all" selected>All</option>
                }
                else
                {
                    <option value="all">All</option>
                }
            </select>

            <label for="countyFilter">County</label>
            <select id="countyFilter" name="countyId">
                <option value="">All Counties</option>
                @foreach (var county in Model.CountyOptions)
                {
                    var countyLabel = county.IsActive ? county.Name : $"{county.Name} (Inactive)";
                    if (selectedCountyId.HasValue && selectedCountyId.Value == county.CountyId)
                    {
                        <option value="@county.CountyId" selected>@countyLabel</option>
                    }
                    else
                    {
                        <option value="@county.CountyId">@countyLabel</option>
                    }
                }
            </select>

            <input type="hidden" name="page" value="1" />
            <input type="hidden" name="pageSize" value="@Model.PageSize" />
            <button type="submit" class="btn btn-secondary">Apply</button>
            <a href="/admin/data-lists/towns-gb" class="btn btn-secondary">Clear</a>
        </form>
    </section>

    <section class="card">
        <h2 class="card-title">Towns</h2>
        @if (Model.Rows.Count == 0)
        {
            <p class="muted">No towns found for the current filter.</p>
        }
        else
        {
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Town ID</th>
                            <th>County</th>
                            <th>Name</th>
                            <th>Slug</th>
                            <th>Status</th>
                            <th>Created (UTC)</th>
                            <th>Updated (UTC)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach (var row in Model.Rows)
                    {
                        var statusKey = row.IsActive ? "active" : "inactive";
                        var statusText = row.IsActive ? "Active" : "Inactive";
                        <tr>
                            <td>@row.TownId</td>
                            <td>@row.CountyName</td>
                            <td>@row.Name</td>
                            <td>@(string.IsNullOrWhiteSpace(row.Slug) ? "N/A" : row.Slug)</td>
                            <td><span class="status-pill status-@statusKey">@statusText</span></td>
                            <td>@row.CreatedUtc.ToString("dd MMM yyyy HH:mm")</td>
                            <td>@row.UpdatedUtc.ToString("dd MMM yyyy HH:mm")</td>
                            <td>
                                <div class="toolbar">
                                    <a class="btn btn-secondary" href="/admin/data-lists/towns-gb/view?townId=@row.TownId&@BuildActionQuery()">View</a>
                                    <a class="btn btn-secondary" href="/admin/data-lists/towns-gb/edit?townId=@row.TownId&@BuildActionQuery()">Edit</a>
                                    @if (row.IsActive)
                                    {
                                        <form method="post" action="/admin/data-lists/towns-gb/mark-inactive?@BuildActionQuery()" onsubmit="return confirm('Mark this town as inactive?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="townId" value="@row.TownId" />
                                            <button type="submit" class="btn btn-secondary">Mark as Inactive</button>
                                        </form>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        }

        <div class="toolbar review-pager">
            @if (hasPrev)
            {
                <a class="btn btn-secondary" href="@BuildListUrl(currentPage - 1)">Previous</a>
            }
            else
            {
                <button type="button" class="btn btn-secondary" disabled>Previous</button>
            }
            <span class="muted">Page @currentPage of @totalPages (@Model.TotalCount total)</span>
            @if (hasNext)
            {
                <a class="btn btn-secondary" href="@BuildListUrl(currentPage + 1)">Next</a>
            }
            else
            {
                <button type="button" class="btn btn-secondary" disabled>Next</button>
            }
        </div>
    </section>
</div>

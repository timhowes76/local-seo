@model EmailLogDetailsViewModel
@{
    ViewData["Title"] = "Email Log Details";
}

<div class="page-stack">
    <section class="card">
        <div class="toolbar">
            <a href="/admin/logs/emails" class="btn btn-secondary">Back to Email Log</a>
            <a href="/admin/logs" class="btn btn-secondary">Back to Logs</a>
        </div>
    </section>

    <section class="card">
        <h2 class="card-title">Email</h2>
        <dl class="details-grid">
            <dt>Created (UTC)</dt>
            <dd>@Model.Log.CreatedUtc.ToString("u")</dd>

            <dt>Template Key</dt>
            <dd>@Model.Log.TemplateKey</dd>

            <dt>Recipient</dt>
            <dd>@Model.Log.ToEmail</dd>

            <dt>From</dt>
            <dd>@(string.IsNullOrWhiteSpace(Model.Log.FromName) ? Model.Log.FromEmail : $"{Model.Log.FromName} <{Model.Log.FromEmail}>")</dd>

            <dt>Status</dt>
            <dd>@Model.Log.Status</dd>

            <dt>Sensitive</dt>
            <dd>@(Model.Log.IsSensitive ? "Yes" : "No")</dd>

            <dt>Redaction Applied</dt>
            <dd>@(Model.Log.RedactionApplied ? "Yes" : "No")</dd>

            <dt>Correlation ID</dt>
            <dd>@(string.IsNullOrWhiteSpace(Model.Log.CorrelationId) ? "N/A" : Model.Log.CorrelationId)</dd>

            <dt>Provider Message ID</dt>
            <dd>@(string.IsNullOrWhiteSpace(Model.Log.SendGridMessageId) ? "N/A" : Model.Log.SendGridMessageId)</dd>

            <dt>Last Provider Event</dt>
            <dd>
                @if (string.IsNullOrWhiteSpace(Model.Log.LastProviderEvent))
                {
                    <span>N/A</span>
                }
                else
                {
                    <span>@Model.Log.LastProviderEvent</span>
                    if (Model.Log.LastProviderEventUtc.HasValue)
                    {
                        <span> (@Model.Log.LastProviderEventUtc.Value.ToString("u"))</span>
                    }
                }
            </dd>

            @if (!string.IsNullOrWhiteSpace(Model.Log.Error))
            {
                <dt>Error</dt>
                <dd>@Model.Log.Error</dd>
            }
        </dl>
    </section>

    <section class="card">
        <h2 class="card-title">Rendered Subject</h2>
        <pre class="code-block">@Model.Log.SubjectRendered</pre>
    </section>

    <section class="card">
        <h2 class="card-title">Rendered HTML Body</h2>
        <p class="muted">Rendered in a sandboxed frame to avoid active scripts.</p>
        <iframe class="email-preview-frame" sandbox="" srcdoc="@Model.Log.BodyHtmlRendered"></iframe>
    </section>

    <section class="card">
        <h2 class="card-title">Provider Events</h2>
        @if (Model.Events.Count == 0)
        {
            <p class="muted">No provider events captured.</p>
        }
        else
        {
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Event (UTC)</th>
                            <th>Type</th>
                            <th>Provider Message ID</th>
                            <th>Payload</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var evt in Model.Events)
                        {
                            <tr>
                                <td>@evt.EventUtc.ToString("u")</td>
                                <td>@evt.EventType</td>
                                <td>@evt.ProviderMessageId</td>
                                <td>
                                    @if (string.IsNullOrWhiteSpace(evt.PayloadJson))
                                    {
                                        <span class="muted">N/A</span>
                                    }
                                    else
                                    {
                                        <details>
                                            <summary>View payload</summary>
                                            <pre class="code-block">@evt.PayloadJson</pre>
                                        </details>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </section>
</div>
